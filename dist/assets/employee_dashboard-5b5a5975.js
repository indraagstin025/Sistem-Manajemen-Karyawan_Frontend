import"./input-214ac174.js";import{u as V}from"./UserServices-9109671c.js";import{a as g}from"./AuthServices-0f733033.js";import{A as W}from"./AttendanceServices-788ac82a.js";import{T as X}from"./toastify-85d374dd.js";import{S as D}from"./sweetalert2.esm.all-9d2ad45a.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace();const H=document.getElementById("profilePhoto"),Z=document.getElementById("employeeName"),ee=document.getElementById("employeePosition"),te=document.getElementById("employeeDepartment"),h=document.getElementById("todayAttendanceStatus"),U=document.getElementById("remainingLeave"),x=document.getElementById("userAvatar"),C=document.getElementById("dropdownMenu"),I=document.getElementById("userDropdown"),ae=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),_=document.getElementById("sidebarToggle"),y=document.getElementById("mobileSidebar"),P=document.getElementById("mobileSidebarPanel"),$=document.getElementById("closeSidebar"),f=document.getElementById("changePasswordModal"),G=document.getElementById("openChangePasswordModalBtn"),R=document.getElementById("closeChangePasswordModalBtn"),N=document.getElementById("cancelChangePasswordBtn"),T=document.getElementById("changePasswordForm"),ne=document.getElementById("oldPassword"),se=document.getElementById("newPassword"),oe=document=document.getElementById("confirmNewPassword"),c=document.getElementById("changePasswordErrorMessage"),w=document.getElementById("changePasswordSuccessMessage"),l=document.getElementById("reader"),o=document.getElementById("qr-scan-result");document.getElementById("notification-message");const p=document.getElementById("camera-select");let u=null,E=!1,v=!1,b=!1;const Q=document.getElementById("current-date"),S=document.getElementById("check-in-time"),m=document.getElementById("attendance-status"),B=document.getElementById("check-out-display"),q=document=document.getElementById("check-out-time"),M=document.getElementById("attendance-note-display"),O=document.getElementById("attendance-note");function z(e,t,n="success",a=!1,d=2e3){D.fire({title:e,text:t,icon:n,showConfirmButton:a,timer:d,timerProgressBar:!0,didOpen:s=>{s.addEventListener("mouseenter",D.stopTimer),s.addEventListener("mouseleave",D.resumeTimer)}})}function r(e,t="success"){let n;t==="success"?n="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?n="linear-gradient(to right, #ef4444, #dc2626)":n="linear-gradient(to right, #3b82f6, #2563eb)",X({text:e,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:n,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()}function F(e){return e||"-"}function re(e){const t=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});Q.textContent=t,m.className="",h.classList.remove("text-gray-900","text-green-600","text-red-600","text-orange-600","text-blue-600"),e?(h.textContent=e.status,e.status==="Hadir"?h.classList.add("text-green-600"):e.status==="Telat"?h.classList.add("text-orange-600"):e.status==="Sakit"||e.status==="Cuti"||e.status==="Izin"?h.classList.add("text-blue-600"):h.classList.add("text-gray-900"),S.textContent=F(e.check_in),m.textContent=e.status,e.status==="Hadir"?m.classList.add("text-green-600","font-semibold"):e.status==="Telat"?m.classList.add("text-orange-600","font-semibold"):e.status==="Sakit"||e.status==="Cuti"||e.status==="Izin"?(S.textContent="-",m.classList.add("text-blue-600","font-semibold"),B.classList.add("hidden")):m.classList.add("text-gray-600","font-semibold"),e.check_out?(B.classList.remove("hidden"),q.textContent=F(e.check_out)):(B.classList.add("hidden"),q.textContent=""),e.note?(M.classList.remove("hidden"),O.textContent=e.note):(M.classList.add("hidden"),O.textContent="")):(h.textContent="Belum Absen",h.classList.add("text-red-600"),S.textContent="-",m.textContent="Belum Absen",m.classList.add("text-red-600","font-semibold"),B.classList.add("hidden"),M.classList.add("hidden"))}async function k(){if(u&&b){try{await u.stop(),await u.clear(),console.log("Scanner dihentikan dan dibersihkan.")}catch(e){console.warn("Gagal menghentikan/membersihkan scanner:",e)}b=!1}l.innerHTML="",o.textContent="",p.classList.add("hidden"),v=!1,u=null}async function j(e,t){var a,d,s;if(E){console.warn("Scan diabaikan karena sedang memproses scan sebelumnya.");return}E=!0,console.log(`QR Code terdeteksi: ${e}`),o.textContent="Memproses...";const n=g.getCurrentUser();if(!n||!n.id){r("User tidak terautentikasi. Silakan login kembali.","error"),o.textContent="Error: User tidak terautentikasi.",await k(),E=!1;return}try{const i=await W.scanQR(e,n.id);z("Absensi Berhasil!",i.message,"success"),o.textContent=i.message,await k(),l.innerHTML='<p class="text-gray-500 mt-8">Absensi berhasil!</p>',A()}catch(i){console.error("Error saat memindai QR Code:",i);const L=((d=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:d.error)||i.message||"Terjadi kesalahan saat absen.";((s=i.response)==null?void 0:s.status)===409?(z("Info Absensi",L,"info"),o.textContent=L,await k(),l.innerHTML=`<p class="text-gray-500 mt-8">${L}</p>`,A()):(r(`Absensi gagal: ${L}`,"error"),o.textContent=`Gagal Absen: ${L}.`,await k(),l.innerHTML=`<p class="text-red-600 mt-8">Gagal absen: ${L}. Harap coba lagi atau hubungi admin.</p>`)}finally{E=!1}}function K(e){}async function Y(){if(u&&u.isScanning&&b){console.log("Scanner sudah berjalan.");return}try{if(!l){console.error("Elemen 'reader' tidak ditemukan di DOM."),o.textContent="Error: Elemen scanner tidak ditemukan.";return}if(await k(),!Html5Qrcode.getCameras){o.textContent="Browser tidak mendukung akses kamera.",l.innerHTML='<p class="text-red-600 mt-8">Browser Anda tidak mendukung akses kamera atau izin ditolak.</p>';return}const e=await Html5Qrcode.getCameras();if(e.length===0){o.textContent="Tidak ada kamera tersedia.",l.innerHTML='<p class="text-red-600 mt-8">Tidak ada kamera yang ditemukan di perangkat Anda.</p>';return}const t=e[0].id;p.innerHTML="",e.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.text=n.label||`Kamera ${n.id}`,p.appendChild(a)}),p.classList.remove("hidden"),p.value=t,p.removeEventListener("change",J),p.addEventListener("change",J),u=new Html5Qrcode("reader"),await u.start({deviceId:{exact:t}},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},j,K),o.textContent="Pindai QR Code untuk Absen...",v=!0,b=!0,console.log("Scanner berhasil dimulai.")}catch(e){console.error("Gagal memulai scanner:",e),o.textContent=`Gagal memulai scanner: ${e.message}`,l.innerHTML=`<p class="text-red-600 mt-8">Gagal memuat scanner: ${e.message}. Pastikan kamera diizinkan.</p>`,p.classList.add("hidden"),v=!1,b=!1}}async function J(e){const t=e.target.value;await ie(t)}async function ie(e){try{await k(),u=new Html5Qrcode("reader"),await u.start({deviceId:{exact:e}},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},j,K),o.textContent="Pindai QR Code untuk Absen...",r("Kamera berhasil diganti.","info"),v=!0,b=!0,console.log("Scanner berhasil di-restart dengan kamera baru.")}catch(t){console.error("Gagal restart scanner:",t),o.textContent=`Gagal mengganti kamera: ${t.message}`,l.innerHTML=`<p class="text-red-600 mt-8">Gagal mengganti kamera: ${t.message}</p>`,v=!1,b=!1}}async function A(){const e=g.getCurrentUser();if(!e||!e.id){r("Gagal memuat status absensi: User tidak terautentikasi.","error"),await k();return}try{const t=await W.getMyHistory(),n=new Date().toISOString().slice(0,10),a=t.find(s=>s.date===n);if(re(a),a&&(a.status==="Hadir"||a.status==="Telat"||a.status==="Sakit"||a.status==="Cuti"||a.status==="Izin"||a.check_in&&a.check_out)){await k();let s="";a.check_in&&a.check_out?s="Anda sudah check-in dan check-out hari ini.":a.check_in&&!a.check_out?s="Anda sudah absen masuk hari ini.":a.status==="Hadir"||a.status==="Telat"?s=`Anda sudah absen masuk hari ini (${a.status}).`:s=`Anda memiliki status hari ini: ${a.status}.`,l.innerHTML=`<p class="text-gray-500 mt-8">${s}</p>`,r(s,"info")}else Y()}catch(t){console.error("Error loading my today attendance:",t),r(`Gagal memuat status absensi: ${t.message}`,"error"),Q.textContent=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}),S.textContent="Gagal memuat",m.textContent="Error",m.classList.add("text-red-600","font-semibold"),Y()}}const de=async()=>{try{if(!localStorage.getItem("token"))return r("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>g.logout(),2e3),null;let t;try{if(t=g.getCurrentUser(),!t)throw new Error("Data pengguna tidak ditemukan di sesi.")}catch(a){throw console.error("Error parsing user from localStorage:",a),new Error("Data pengguna di sesi rusak.")}if(t.role!=="karyawan")return r("Akses ditolak. Peran tidak sesuai untuk halaman ini.","error"),setTimeout(()=>g.logout(),2e3),null;const n=await V.getUserByID(t.id);if(n){try{const a=await V.getProfilePhoto(t.id),d=URL.createObjectURL(a);H.src=d,x&&(x.src=d,x.alt=n.name)}catch{const a="https://via.placeholder.com/80/4A5568/E2E8F0?text=ME";H.src=a,x&&(x.src=a,x.alt=n.name)}Z.textContent=n.name,ee.textContent=n.position||"-",te.textContent=n.department||"-",n.annual_leave_balance!==void 0&&n.annual_leave_balance!==null?U.textContent=`${n.annual_leave_balance} Hari`:U.textContent="N/A"}return n}catch(e){return console.error("Error fetching employee profile data:",e),r(e.message||"Gagal memuat data profil.","error"),(e.status===401||e.message&&(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Peran tidak sesuai")||e.message.includes("Data pengguna di sesi rusak")))&&setTimeout(()=>g.logout(),2e3),null}},ce=()=>{T.reset(),c.classList.add("hidden"),w.classList.add("hidden"),c.textContent="",w.textContent=""};if(G&&G.addEventListener("click",e=>{e.preventDefault(),ce(),f.classList.remove("hidden"),setTimeout(()=>f.classList.add("active"),10),C&&C.classList.remove("active")}),R&&R.addEventListener("click",()=>{f.classList.remove("active"),setTimeout(()=>f.classList.add("hidden"),300)}),N&&N.addEventListener("click",()=>{f.classList.remove("active"),setTimeout(()=>f.classList.add("hidden"),300)}),T&&T.addEventListener("submit",async e=>{e.preventDefault(),c.classList.add("hidden"),w.classList.add("hidden"),c.textContent="",w.textContent="";const t=ne.value,n=se.value,a=oe.value;if(n!==a){c.textContent="Password baru dan konfirmasi password tidak cocok.",c.classList.remove("hidden");return}if(n.length<6){c.textContent="Password baru minimal 6 karakter.",c.classList.remove("hidden");return}const d=g.getCurrentUser();if(!d||!d.id||!localStorage.getItem("token")){r("Sesi tidak valid. Harap login kembali.","error"),setTimeout(()=>g.logout(),2e3);return}try{const s=await g.changePassword(t,n);w.textContent=s.message||"Password berhasil diubah!",w.classList.remove("hidden"),r("Password berhasil diubah!","success"),setTimeout(()=>{f.classList.remove("active"),setTimeout(()=>f.classList.add("hidden"),300)},1500)}catch(s){console.error("Error changing password:",s);const i=s.message||"Gagal mengubah password. Silakan coba lagi.";c.textContent=i,c.classList.remove("hidden"),r(i,"error")}}),I&&(I.addEventListener("click",()=>{C.classList.toggle("active")}),document.addEventListener("click",e=>{I.contains(e.target)||C.classList.remove("active")})),ae.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),le()})}),_&&y&&P&&$){const e=()=>{y.classList.remove("hidden"),setTimeout(()=>{y.classList.add("opacity-100"),P.classList.remove("-translate-x-full")},10)},t=()=>{y.classList.remove("opacity-100"),P.classList.add("-translate-x-full"),setTimeout(()=>y.classList.add("hidden"),300)};_.addEventListener("click",e),$.addEventListener("click",t),y.addEventListener("click",n=>{n.target===y&&t()})}const le=()=>{const e=document.createElement("div");e.className="flex flex-col items-center p-2",e.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
            <div class="flex space-x-3">
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const t=X({node:e,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();e.querySelector("#confirmLogoutBtn").addEventListener("click",()=>{g.logout(),t.hideToast()}),e.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{t.hideToast()})};await de()&&A()});
