import"./input-ac4e21e1.js";import{C as P,i as q,a as O,b as Q,l as K,W as c}from"./WorkScheduleServices-6b431584.js";import{a as p}from"./AuthServices-0f733033.js";import{i as U}from"./sidebarHandler-d6522c99.js";import{i as H,S as B}from"./logoutHandler-a2e70173.js";import{Q as u}from"./qrCodeHandler-3c60f548.js";import{T as z}from"./toastify-3acd0462.js";import"./AttendanceServices-9bf2f837.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),U(),H({preLogoutCallback:()=>{typeof u<"u"&&u.close&&u.close()}}),u.initialize({toastCallback:(e,t)=>{let r;t==="success"?r="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?r="linear-gradient(to right, #ef4444, #dc2626)":r="linear-gradient(to right, #3b82f6, #2563eb)",z({text:e,duration:3e3,close:!0,gravity:"top",position:"right",style:{background:r,borderRadius:"8px"}}).showToast()}});const v=document.getElementById("scheduleFormModal"),A=document.getElementById("closeScheduleModalBtn"),w=document.getElementById("workScheduleForm"),C=document.getElementById("form-modal-title"),y=document.getElementById("schedule-id"),E=document.getElementById("schedule-date"),I=document.getElementById("start-time"),L=document.getElementById("end-time"),D=document.getElementById("note"),S=document.getElementById("save-schedule-btn"),W=document.getElementById("cancel-schedule-btn"),m=document.getElementById("delete-schedule-btn"),$=document.getElementById("manualAddScheduleBtn"),o=document.getElementById("recurrence-freq"),h=document.getElementById("weekly-options"),g=document.querySelectorAll(".weekday-checkbox"),k=document.getElementById("recurrence-until"),d=document.getElementById("userAvatar"),T=document.getElementById("userDropdown"),M=document.getElementById("dropdownMenu");let f;const i=(e,t,r="success",a=!1,s=2e3)=>{B.fire({title:e,html:t,icon:r,showConfirmButton:a,timer:s,timerProgressBar:!0,didOpen:l=>{s>0&&(l.addEventListener("mouseenter",B.stopTimer),l.addEventListener("mouseleave",B.resumeTimer))}})},G=async()=>{try{const e=await p.getCurrentUser();e&&e.photo_url&&d?d.src=e.photo_url:d&&(d.src="/assets/default-avatar.png")}catch(e){console.error("Gagal memuat profil pengguna:",e),d&&(d.src="/assets/default-avatar.png")}};o.addEventListener("change",()=>{o.value==="WEEKLY"?h.classList.remove("hidden"):(h.classList.add("hidden"),g.forEach(e=>e.checked=!1))});const Y=()=>{const e=o.value;if(e==="NONE")return"";let t=`FREQ=${e}`;if(e==="WEEKLY"){const r=Array.from(g).filter(a=>a.checked).map(a=>a.value);if(r.length===0)return i("Validasi Gagal","Pilih minimal satu hari untuk jadwal mingguan.","warning"),"";t+=`;BYDAY=${r.join(",")}`}if(k.value){const r=k.value.replace(/-/g,"");t+=`;UNTIL=${r}T235959Z`}return t},j=(e="create",t=null)=>{if(v.classList.remove("hidden"),setTimeout(()=>v.classList.add("active"),10),m.classList.add("hidden"),e==="create")C.textContent="Tambah Jadwal Kerja",w.reset(),h.classList.add("hidden"),y.value="",E.value=new Date().toISOString().split("T")[0],I.value="09:00",L.value="17:00",g.forEach(r=>r.checked=!1),o.value="NONE",k.value="";else if(e==="edit"&&t){C.textContent="Edit Aturan Jadwal Kerja",y.value=t.id,E.value=t.date,I.value=t.start_time.substring(0,5),L.value=t.end_time.substring(0,5),D.value=t.note||"";const r=t.recurrence_rule?t.recurrence_rule.split(";"):[];let a="NONE",s=[],l="";r.forEach(n=>{n.startsWith("FREQ=")?a=n.replace("FREQ=",""):n.startsWith("BYDAY=")?s=n.replace("BYDAY=","").split(","):n.startsWith("UNTIL=")&&(l=n.replace("UNTIL=","").substring(0,8))}),o.value=a,a==="WEEKLY"?(h.classList.remove("hidden"),g.forEach(n=>{n.checked=s.includes(n.value)})):(h.classList.add("hidden"),g.forEach(n=>n.checked=!1)),k.value=l?`${l.substring(0,4)}-${l.substring(4,6)}-${l.substring(6,8)}`:"",m.classList.remove("hidden")}},b=()=>{v.classList.remove("active"),setTimeout(()=>{v.classList.add("hidden"),w.reset()},300)},F=document.getElementById("calendar");f=new P(F,{plugins:[q,O,Q],initialView:"dayGridMonth",locale:K,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},editable:!0,selectable:!0,displayEventTime:!1,eventSources:[{events:async e=>{try{const t={start_date:e.startStr.split("T")[0],end_date:e.endStr.split("T")[0]};return((await c.getAllWorkSchedules(t)).data||[]).map(a=>({id:a.id,title:`${a.start_time.substring(0,5)} - ${a.end_time.substring(0,5)}`,start:a.date,extendedProps:{start_time:a.start_time,end_time:a.end_time,note:a.note,recurrence_rule:a.recurrence_rule},allDay:!0,color:"#38b2ac",textColor:"white",display:"block"}))}catch(t){return console.error("Error fetching work schedules:",t),i("Error Fetching Schedules",`Gagal memuat jadwal kerja: ${t.message||"Terjadi kesalahan."}`,"error",!0),(t.status===401||t.status===403)&&setTimeout(()=>p.logout(),2e3),[]}},color:"#38b2ac",textColor:"white"},{events:async e=>{try{const t=e.start.getFullYear();return(await c.getHolidays(t)||[]).map(a=>({title:a.Name,start:a.Date,allDay:!0,display:"background",color:"#ff9f89"}))}catch(t){return console.error("Error fetching holidays:",t),i("Error Fetching Holidays",`Gagal memuat hari libur: ${t.message||"Terjadi kesalahan."}`,"error",!0),[]}}}],select:e=>{j("create"),E.value=e.startStr.split("T")[0],f.unselect()},eventClick:async e=>{const t=e.event.id;if(e.event.display==="background"){i("Info Hari Libur",`Hari libur: ${e.event.title}`,"info");return}try{const a=(await c.getWorkScheduleById(t)).data;a?j("edit",a):i("Data Tidak Ditemukan","Detail jadwal tidak ditemukan.","error")}catch(r){console.error("Error fetching schedule for edit:",r),i("Gagal Memuat Jadwal",`Gagal memuat detail jadwal untuk diedit: ${r.message||"Terjadi kesalahan."}`,"error",!0),(r.status===401||r.status===403)&&setTimeout(()=>p.logout(),2e3)}}}),f.render(),$.addEventListener("click",()=>j("create")),A.addEventListener("click",b),W.addEventListener("click",b);const _=document.getElementById("generate-qr-menu-btn"),x=document.getElementById("generate-qr-menu-btn-mobile");_&&_.addEventListener("click",()=>u.open()),x&&x.addEventListener("click",()=>{const e=document.getElementById("mobileSidebar"),t=document.getElementById("mobileSidebarPanel");e&&t&&(e.classList.remove("opacity-100"),t.classList.add("-translate-x-full"),setTimeout(()=>{e.classList.add("hidden")},300)),u.open()}),T&&(T.addEventListener("click",e=>{e.stopPropagation(),M.classList.toggle("active")}),document.addEventListener("click",e=>{T.contains(e.target)||M.classList.remove("active")})),w.addEventListener("submit",async e=>{var s,l;e.preventDefault(),S.disabled=!0;const t=y.value,r=Y();if(o.value==="WEEKLY"&&!r){S.disabled=!1;return}const a={date:E.value,start_time:I.value,end_time:L.value,note:D.value,recurrence_rule:r};try{t?(await c.updateWorkSchedule(t,a),i("Berhasil!","Aturan jadwal kerja berhasil diperbarui!","success",!1,1500)):(await c.createWorkSchedule(a),i("Berhasil!","Aturan jadwal kerja berhasil disimpan!","success",!1,1500)),b(),f.refetchEvents()}catch(n){console.error("Error saving/updating work schedule:",n);const N=((l=(s=n.response)==null?void 0:s.data)==null?void 0:l.error)||n.message||"Terjadi kesalahan saat menyimpan/memperbarui jadwal.";i("Gagal!",N,"error",!0),(n.status===401||n.status===403)&&setTimeout(()=>p.logout(),2e3)}finally{S.disabled=!1}}),m.addEventListener("click",async()=>{const e=y.value;e&&B.fire({title:"Anda yakin ingin menghapus?",text:"Aturan jadwal ini akan dihapus secara permanen, termasuk semua kejadian di masa mendatang.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Ya, Hapus!",cancelButtonText:"Batal"}).then(async t=>{var r,a;if(t.isConfirmed){m.disabled=!0;try{await c.deleteWorkSchedule(e),i("Terhapus!","Aturan jadwal kerja berhasil dihapus!","success",!1,1500),b(),f.refetchEvents()}catch(s){console.error("Error deleting work schedule:",s);const l=((a=(r=s.response)==null?void 0:r.data)==null?void 0:a.error)||s.message||"Terjadi kesalahan saat menghapus jadwal.";i("Gagal!",l,"error",!0),(s.status===401||s.status===403)&&setTimeout(()=>p.logout(),2e3)}finally{m.disabled=!1}}})}),G()});
