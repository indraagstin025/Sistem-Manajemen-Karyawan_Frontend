import"./input-87732271.js";import{L as O}from"./LeaveRequestsServices-57462767.js";import{a as T}from"./AuthServices-0f733033.js";import{i as q}from"./sidebarHandler-d6522c99.js";import{i as X,S as J}from"./logoutHandler-a2e70173.js";import{Q as B}from"./qrCodeHandler-3c60f548.js";import{g as V}from"./photoUtils-c92e179b.js";import{T as Z}from"./toastify-3acd0462.js";/* empty css                 */import"./AttendanceServices-9bf2f837.js";import"./UserServices-9109671c.js";const tt="https://sistem-manajemen-karyawanbackend-production.up.railway.app",et=c=>c?c.startsWith("http://")||c.startsWith("https://")?c:`${tt}${c}`:null,p=(c,b="success")=>{let k;b==="success"?k="linear-gradient(to right, #22c55e, #16a34a)":b==="error"?k="linear-gradient(to right, #ef4444, #dc2626)":k="linear-gradient(to right, #3b82f6, #2563eb)",Z({text:c,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:k,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},at=()=>{J.fire({title:"Anda yakin ingin keluar?",text:"Anda akan diarahkan ke halaman login.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, Keluar",cancelButtonText:"Batal"}).then(c=>{c.isConfirmed&&T.logout()})};document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),q(),B.initialize({toastCallback:p}),X({preLogoutCallback:()=>{typeof B<"u"&&B.close&&B.close()}});const c=document.getElementById("leaveRequestsTableBody"),b=document.getElementById("leaveRequestsMessage"),k=document.getElementById("userAvatar"),H=document.getElementById("userNameNav"),w=document.getElementById("dropdownMenu"),W=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),j=document.getElementById("paginationControls"),$=document.getElementById("prevPageBtn"),M=document.getElementById("nextPageBtn"),K=document.getElementById("currentPageInfo"),d=document.getElementById("attachmentViewerModal"),z=document.getElementById("closeAttachmentViewerModalBtn"),E=document.getElementById("attachmentContent"),h=document.getElementById("attachmentErrorMessage"),N=document.getElementById("attachmentModalTitle");let x=1;const y=10;let v=[];const Q=async()=>{try{if(!localStorage.getItem("token"))return;let n=T.getCurrentUser();if(!n||n.role!=="admin")return;const r=await V(n.id,n.name,40);k&&(k.src=r,k.alt=n.name||"Admin"),H&&(H.textContent=n.name||"Admin")}catch(a){console.error("Error fetching admin profile data for header:",a)}},G=async()=>{c.innerHTML=`
            <tr>
                <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat pengajuan...</td>
            </tr>
            `,b.classList.add("hidden"),j.classList.add("hidden");try{if(!localStorage.getItem("token")){p("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>T.logout(),2e3);return}const n=T.getCurrentUser();if(!n||n.role!=="admin"){p("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>T.logout(),2e3);return}v=await O.getAllLeaveRequests()||[],v.sort((s,l)=>s.status==="pending"&&l.status!=="pending"?-1:s.status!=="pending"&&l.status==="pending"?1:new Date(l.createdAt)-new Date(s.createdAt)),v.length===0?(c.innerHTML=`
                                <tr>
                                    <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada pengajuan cuti/izin yang ditemukan.</td>
                                </tr>
                            `,b.textContent="Tidak ada pengajuan cuti atau izin yang perlu ditinjau.",b.classList.remove("hidden")):(S(v,x,y),I(v.length,x,y))}catch(a){console.error("Error loading leave requests:",a),c.innerHTML=`
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat pengajuan: ${a.message}</td>
                        </tr>
                    `,p(a.message||"Gagal memuat pengajuan cuti/izin.","error"),(a.message.includes("token")||a.message.includes("sesi")||a.message.includes("Akses ditolak"))&&setTimeout(()=>T.logout(),2e3)}},A=async a=>{const n=a.currentTarget,r=n.dataset.url;let s=n.dataset.filename;if(d.classList.remove("active"),d.classList.add("hidden"),E.innerHTML="",h.classList.add("hidden"),N.textContent=`Lihat Lampiran: ${s||"Memuat..."}`,!r){h.textContent="URL lampiran tidak ditemukan.",h.classList.remove("hidden"),p("URL lampiran tidak ditemukan.","error");return}const l=localStorage.getItem("token");if(!l){h.textContent="Sesi tidak valid. Harap login ulang.",h.classList.remove("hidden"),p("Sesi tidak valid. Harap login ulang.","error");return}d.classList.remove("hidden"),setTimeout(()=>d.classList.add("active"),10);try{const i=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${l}`}});if(!i.ok){const e=await i.text();let o=`Gagal memuat lampiran: ${i.status}`;try{o=JSON.parse(e).message||o}catch{o=`${o} - ${e.substring(0,100)}...`}throw new Error(o)}const t=await i.blob(),g=URL.createObjectURL(t),m=i.headers.get("Content-Disposition");if(m&&m.includes("filename=")){const e=m.match(/filename="?(.+)"?/);e&&e[1]&&(s=e[1].replace(/['"]/g,""))}N.textContent=`Lihat Lampiran: ${s||"Tidak Diketahui"}`;const f=i.headers.get("Content-Type")||t.type;if(f.startsWith("image/")){const e=document.createElement("img");e.src=g,e.alt=s,e.className="max-w-full max-h-full object-contain",E.appendChild(e)}else if(f==="application/pdf"){const e=document.createElement("iframe");e.src=g,e.style.width="100%",e.style.height="100%",e.style.border="none",e.setAttribute("allowfullscreen",""),e.setAttribute("webkitallowfullscreen",""),e.setAttribute("mozallowfullscreen",""),E.appendChild(e)}else{h.textContent=`Tipe file '${f||"tidak diketahui"}' tidak didukung untuk tampilan langsung. Silakan unduh.`,h.classList.remove("hidden");const e=document.createElement("button");e.textContent="Unduh File",e.className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",e.addEventListener("click",()=>C({target:{dataset:{url:r,filename:s}}})),E.appendChild(e)}d.addEventListener("transitionend",function e(){d.classList.contains("hidden")&&(URL.revokeObjectURL(g),d.removeEventListener("transitionend",e))},{once:!0})}catch(i){console.error("Gagal memuat lampiran untuk tampilan:",i),h.textContent=i.message||"Terjadi kesalahan saat memuat lampiran.",h.classList.remove("hidden"),p(i.message||"Gagal memuat lampiran.","error"),d.classList.remove("active"),setTimeout(()=>d.classList.add("hidden"),300)}},C=async a=>{const n=a.target,r=n.dataset.url,s=n.dataset.filename;if(!r){p("URL lampiran tidak ditemukan.","error");return}const l=localStorage.getItem("token");if(!l){p("Sesi tidak valid. Silakan login ulang.","error");return}const i=n.textContent;n.disabled=!0,n.textContent="Mengunduh...";try{const t=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${l}`}});if(!t.ok){const u=await t.text();let L=`Gagal mengunduh file: ${t.status}`;try{L=JSON.parse(u).message||L}catch{L=`${L} - ${u.substring(0,100)}...`}throw new Error(L)}const g=t.headers.get("Content-Disposition");let m="file";if(g&&g.includes("filename=")){const u=g.match(/filename="?(.+)"?/);u&&u[1]&&(m=u[1].replace(/['"]/g,""))}else if(s)m=s;else{const u=r.split("/");m=u[u.length-1].split("?")[0]}const f=await t.blob(),e=URL.createObjectURL(f),o=document.createElement("a");o.href=e,o.download=m,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(e),p("File berhasil diunduh!","success")}catch(t){console.error("Gagal mengunduh file:",t),p(t.message||"Terjadi kesalahan saat mengunduh file.","error")}finally{n.disabled=!1,n.textContent=i}},S=(a,n,r)=>{const s=document.getElementById("leaveRequestsTableBody");if(!s)return;s.innerHTML="";const l=(n-1)*r,i=a.slice(l,l+r);if(i.length===0){s.innerHTML='<tr><td colspan="9" class="text-center py-10 text-gray-500">Tidak ada data pengajuan.</td></tr>';return}i.forEach(t=>{const g=s.insertRow(),m=new Date(t.start_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),f=new Date(t.end_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});let e="pending",o="Menunggu";t.status==="approved"?(e="approved",o="Disetujui"):t.status==="rejected"?(e="rejected",o="Ditolak"):t.status==="completed"&&(e="completed",o="Selesai");const u=et(t.attachment_url),L=t.attachment_url?t.attachment_url.split("/").pop().split("?")[0]:"",U=u?`<div class="flex items-center space-x-2">
                            <button class="view-attachment-btn text-teal-600 hover:underline focus:outline-none" data-url="${u}" data-filename="${L}">Lihat</button>
                            <button class="download-btn text-gray-500 hover:text-gray-700" data-url="${u}" data-filename="${L}" title="Unduh Lampiran">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                        </div>`:"-",P=t.user_name||t.user_email||"Pengguna Tidak Dikenal",_=`photo-${t.id}`;g.innerHTML=`
                <td>
                    <div class="employee-info flex items-center space-x-3 px-6 py-4 whitespace-nowrap">
                        <img id="${_}" class="h-9 w-9 rounded-full object-cover" src="https://placehold.co/36x36/E2E8F0/4A5568?text=ME" alt="${P}">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${P}</div>
                            <div class="text-sm text-gray-500">${t.user_email||"-"}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.request_type||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${f}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis" title="${t.reason||""}">${t.reason||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${U}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                    <span class="status-badge ${e}">${o}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis" title="${t.note||""}">${t.note||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    ${t.status==="pending"?`
                            <div class="action-buttons flex space-x-2 justify-end">
                                <button data-id="${t.id}" data-action="approve" class="action-btn px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md transition-colors duration-200">Setujui</button>
                                <button data-id="${t.id}" data-action="reject" class="action-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition-colors duration-200">Tolak</button>
                            </div>
                            `:'<span class="text-gray-500 text-xs">Selesai</span>'}
                </td>
            `,V(t.user_id,P,36).then(Y=>{const F=document.getElementById(_);F&&(F.src=Y)})}),s.querySelectorAll(".view-attachment-btn").forEach(t=>{t.removeEventListener("click",A),t.addEventListener("click",A)}),s.querySelectorAll(".download-btn").forEach(t=>{t.removeEventListener("click",C),t.addEventListener("click",C)}),s.querySelectorAll(".action-btn").forEach(t=>{t.removeEventListener("click",D),t.addEventListener("click",D)})},I=(a,n,r)=>{const s=Math.ceil(a/r);K.textContent=`Halaman ${n} dari ${s}`,$.disabled=n===1;const l=a===0||n===s;M.disabled=l,a>r?j.classList.remove("hidden"):j.classList.add("hidden")},D=async a=>{const n=a.target,r=n.dataset.id,s=n.dataset.action;let l="",i="",t="",g="",m="",f="question";if(s==="approve")l="approved",i="Setujui Pengajuan Ini?",t="Anda akan menyetujui pengajuan cuti/izin ini.",g="Catatan persetujuan (wajib)",m="Catatan Persetujuan:",f="success";else if(s==="reject")l="rejected",i="Tolak Pengajuan Ini?",t="Anda akan menolak pengajuan cuti/izin ini.",g="Catatan penolakan (wajib)",m="Catatan Penolakan:",f="error";else return;const{value:e}=await J.fire({title:i,text:t,icon:f,input:"textarea",inputLabel:m,inputPlaceholder:g,inputValidator:o=>{if(!o||o.trim()==="")return"Catatan wajib diisi!"},showCancelButton:!0,confirmButtonText:"Ya, Proses",cancelButtonText:"Batal",confirmButtonColor:s==="approve"?"#10b981":"#dc2626",cancelButtonColor:"#6b7280",reverseButtons:!0});if(e==null||e.trim()===""){p("Proses dibatalkan: Catatan tidak diisi.","info");return}try{n.disabled=!0,n.textContent="Memproses...",await O.updateLeaveRequestStatus(r,l,e),p(`Pengajuan berhasil ${s==="approve"?"disetujui":"ditolak"}.`,"success"),G()}catch(o){console.error("Error updating leave request status:",o),p(o.message||"Gagal memperbarui status pengajuan.","error"),n.disabled=!1,n.textContent=s==="approve"?"Setujui":"Tolak"}};$&&$.addEventListener("click",()=>{x>1&&(x--,S(v,x,y),I(v.length,x,y))}),M&&M.addEventListener("click",()=>{const a=Math.ceil(v.length/y);x<a&&(x++,S(v,x,y),I(v.length,x,y))}),c&&c.addEventListener("click",a=>{const n=a.target;n.classList.contains("action-btn")?D(a):n.classList.contains("view-attachment-btn")?A(a):n.classList.contains("download-btn")&&C(a)});const R=document.getElementById("userDropdown");R&&w&&(R.addEventListener("click",a=>{!w.contains(a.target)&&a.target.closest("#userAvatar")&&(w.classList.toggle("hidden"),w.classList.toggle("active"))}),document.addEventListener("click",a=>{w&&!R.contains(a.target)&&!w.contains(a.target)&&(w.classList.remove("active"),setTimeout(()=>{w.classList.add("hidden")},200))},!0)),W.forEach(a=>{a.addEventListener("click",n=>{n.preventDefault(),at()})}),z&&(z.addEventListener("click",()=>{d.classList.remove("active"),setTimeout(()=>{d.classList.add("hidden"),E.innerHTML="",h.classList.add("hidden")},300)}),d.addEventListener("click",a=>{a.target===d&&(d.classList.remove("active"),setTimeout(()=>{d.classList.add("hidden"),E.innerHTML="",h.classList.add("hidden")},300))})),Q(),G()});
