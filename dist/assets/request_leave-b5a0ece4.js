import"./input-214ac174.js";import{a as l}from"./AuthServices-0f733033.js";import{u as se}from"./UserServices-9109671c.js";import{L as U}from"./LeaveRequestsServices-d7327dcf.js";import{T as N}from"./toastify-85d374dd.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace();const E=document.getElementById("userAvatar"),L=document.getElementById("dropdownMenu"),B=document.getElementById("userDropdown"),G=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),A=document.getElementById("sidebarToggle"),g=document.getElementById("mobileSidebar"),I=document.getElementById("mobileSidebarPanel"),H=document.getElementById("closeSidebar"),u=document.getElementById("changePasswordModal"),q=document.getElementById("openChangePasswordModalBtn"),_=document.getElementById("closeChangePasswordModalBtn"),$=document.getElementById("cancelChangePasswordBtn"),P=document.getElementById("changePasswordForm"),z=document.getElementById("oldPassword"),O=document.getElementById("newPassword"),K=document.getElementById("confirmNewPassword"),i=document.getElementById("changePasswordErrorMessage"),h=document.getElementById("changePasswordSuccessMessage"),F=document.getElementById("leaveRequestForm"),f=document.getElementById("requestType"),Y=document.getElementById("startDate"),J=document.getElementById("endDate"),Q=document.getElementById("reason"),M=document.getElementById("attachmentSection"),y=document.getElementById("attachment"),n=document.getElementById("formMessage"),v=document.getElementById("leaveHistoryTableBody"),x=document.getElementById("leaveHistoryMessage"),b=document.getElementById("paginationControls"),T=document.getElementById("prevPageBtn"),C=document.getElementById("nextPageBtn"),V=document.getElementById("currentPageInfo");let c=1;const m=5;let o=[];const r=(e,t="success")=>{let a;t==="success"?a="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?a="linear-gradient(to right, #ef4444, #dc2626)":a="linear-gradient(to right, #3b82f6, #2563eb)",N({text:e,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:a,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},W=async()=>{try{let e=l.getCurrentUser();if(!e||!e.id)return null;const t=await se.getUserByID(e.id);return t&&E&&(E.src=t.photo||"https://via.placeholder.com/40x40/E2E8F0/4A5568?text=ME",E.alt=t.name),t}catch(e){return console.error("Error fetching employee profile data for header:",e),e.status===401||e.status===403?(r("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>l.logout(),2e3)):r(e.message||"Gagal memuat data profil header.","error"),null}},R=async()=>{v.innerHTML=`
            <tr>
                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat riwayat pengajuan...</td>
            </tr>
        `,x.classList.add("hidden"),b.classList.add("hidden");try{const e=l.getCurrentUser();if(!e||e.role!=="karyawan"){r("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>l.logout(),2e3);return}let t=await U.getMyLeaveRequests();Array.isArray(t)||(console.warn("Peringatan: API /leave-requests/my-requests tidak mengembalikan array. Menerima:",t),t=[],r("Peringatan: Format data riwayat pengajuan tidak valid dari server.","info")),o=t,o.sort((a,s)=>new Date(s.created_at)-new Date(a.created_at)),o.length===0?(v.innerHTML=`
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada riwayat pengajuan cuti/izin.</td>
                    </tr>
                `,x.textContent="Anda belum memiliki riwayat pengajuan cuti atau izin.",x.classList.remove("hidden"),x.classList.add("info")):(D(o,c,m),S(o.length,c,m),o.length>m&&b.classList.remove("hidden"))}catch(e){console.error("Error loading leave history:",e),v.innerHTML=`
                <tr>
                    <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat riwayat pengajuan: ${e.message}</td>
                </tr>
            `,r(e.message||"Gagal memuat riwayat pengajuan.","error"),(e.status===401||e.status===403)&&setTimeout(()=>l.logout(),2e3)}},D=(e,t,a)=>{v.innerHTML="";const s=(t-1)*a,p=s+a;e.slice(s,p).forEach(d=>{const ee=v.insertRow(),te=new Date(d.start_date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}),ae=new Date(d.end_date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});let w="",k=d.status;switch(d.status){case"pending":w="text-yellow-600",k="Menunggu";break;case"approved":w="text-green-600",k="Disetujui";break;case"rejected":w="text-red-600",k="Ditolak";break;default:w="text-gray-600";break}ee.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${te}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ae}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${d.request_type||"-"}</td>
                <td class="px-6 py-4 text-sm text-gray-700 max-w-xs overflow-hidden text-ellipsis">${d.reason||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${w} font-semibold">${k}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    ${d.attachment_url?`<a href="${d.attachment_url}" target="_blank" class="text-teal-600 hover:underline">Lihat Lampiran</a>`:"-"}
                </td>
            `})},S=(e,t,a)=>{const s=Math.ceil(e/a);V.textContent=`Halaman ${t} dari ${s}`,T.disabled=t===1,C.disabled=t===s||s===0,e>a?b.classList.remove("hidden"):b.classList.add("hidden")};T&&T.addEventListener("click",()=>{c>1&&(c--,D(o,c,m),S(o.length,c,m))}),C&&C.addEventListener("click",()=>{const e=Math.ceil(o.length/m);c<e&&(c++,D(o,c,m),S(o.length,c,m))}),f.addEventListener("change",()=>{f.value==="Sakit"?(M.classList.remove("hidden"),y.setAttribute("required","required")):(M.classList.add("hidden"),y.removeAttribute("required"),y.value="")}),F.addEventListener("submit",async e=>{e.preventDefault(),n.classList.add("hidden"),n.textContent="";const t=new FormData;t.append("request_type",f.value),t.append("start_date",Y.value),t.append("end_date",J.value),t.append("reason",Q.value);const a=y.files[0];if(a){if(a.size>2*1024*1024){r("Ukuran file terlalu besar! Maksimal 2MB.","error"),n.textContent="Ukuran file terlalu besar! Maksimal 2MB.",n.classList.remove("hidden"),n.classList.add("error");return}t.append("attachment",a)}else if(f.value==="Sakit"&&y.hasAttribute("required")){r("Lampiran (surat dokter) wajib untuk pengajuan Sakit.","error"),n.textContent="Lampiran (surat dokter) wajib untuk pengajuan Sakit.",n.classList.remove("hidden"),n.classList.add("error");return}try{const s=await U.createLeaveRequest(t);r(s.message||"Pengajuan berhasil dikirim!","success"),n.textContent="Pengajuan berhasil dikirim dan menunggu persetujuan admin.",n.classList.remove("hidden"),n.classList.remove("error"),n.classList.add("success"),F.reset(),M.classList.add("hidden"),y.removeAttribute("required"),R()}catch(s){console.error("Error submitting leave request:",s);const p=s.message||"Gagal mengirim pengajuan. Silakan coba lagi.";r(p,"error"),n.textContent=p,n.classList.remove("hidden"),n.classList.remove("success"),n.classList.add("error"),(s.status===401||s.status===403)&&setTimeout(()=>l.logout(),2e3)}});const X=()=>{P.reset(),i.classList.add("hidden"),h.classList.add("hidden"),i.textContent="",h.textContent=""};if(q&&q.addEventListener("click",e=>{e.preventDefault(),X(),u.classList.remove("hidden"),setTimeout(()=>u.classList.add("active"),10),L&&L.classList.remove("active")}),_&&_.addEventListener("click",()=>{u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)}),$&&$.addEventListener("click",()=>{u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)}),P&&P.addEventListener("submit",async e=>{e.preventDefault(),i.classList.add("hidden"),h.classList.add("hidden"),i.textContent="",h.textContent="";const t=z.value,a=O.value,s=K.value;if(a!==s){i.textContent="Password baru dan konfirmasi password tidak cocok.",i.classList.remove("hidden");return}if(a.length<6){i.textContent="Password baru minimal 6 karakter.",i.classList.remove("hidden");return}const p=l.getCurrentUser();if(!p||!p.id){r("Sesi tidak valid. Harap login kembali.","error"),setTimeout(()=>l.logout(),2e3);return}try{await l.changePassword(t,a),h.textContent="Password berhasil diubah!",h.classList.remove("hidden"),r("Password berhasil diubah!","success"),setTimeout(()=>{u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)},1500)}catch(j){console.error("Error changing password:",j);const d=j.message||"Gagal mengubah password. Silakan coba lagi.";i.textContent=d,i.classList.remove("hidden"),r(d,"error")}}),B&&(B.addEventListener("click",()=>{L.classList.toggle("active")}),document.addEventListener("click",e=>{B.contains(e.target)||L.classList.remove("active")})),G.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),Z()})}),A&&g&&I&&H){const e=()=>{g.classList.remove("hidden"),setTimeout(()=>{g.classList.add("opacity-100"),I.classList.remove("-translate-x-full")},10)},t=()=>{g.classList.remove("opacity-100"),I.classList.add("-translate-x-full"),setTimeout(()=>g.classList.add("hidden"),300)};A.addEventListener("click",e),H.addEventListener("click",t),g.addEventListener("click",a=>{a.target===g&&t()})}const Z=()=>{const e=document.createElement("div");e.className="flex flex-col items-center p-2",e.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
            <div class="flex space-x-3">
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const t=N({node:e,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();e.querySelector("#confirmLogoutBtn").addEventListener("click",()=>{l.logout(),t.hideToast()}),e.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{t.hideToast()})};W(),R()});
