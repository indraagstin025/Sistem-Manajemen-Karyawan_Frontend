import"./input-214ac174.js";import{A as j}from"./AttendanceServices-788ac82a.js";import{a as d}from"./AuthServices-0f733033.js";import{u as J}from"./UserServices-9109671c.js";import{T as $}from"./toastify-85d374dd.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace();const p=document.getElementById("attendanceHistoryTableBody"),w=document.getElementById("attendanceHistoryMessage"),v=document.getElementById("userAvatar"),f=document.getElementById("dropdownMenu"),L=document.getElementById("userDropdown"),F=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),C=document.getElementById("sidebarToggle"),g=document.getElementById("mobileSidebar"),k=document.getElementById("mobileSidebarPanel"),S=document.getElementById("closeSidebar"),c=document.getElementById("changePasswordModal"),A=document.getElementById("openChangePasswordModalBtn"),D=document.getElementById("closeChangePasswordModalBtn"),H=document.getElementById("cancelChangePasswordBtn"),E=document.getElementById("changePasswordForm"),N=document.getElementById("oldPassword"),U=document.getElementById("newPassword"),G=document.getElementById("confirmNewPassword"),o=document.getElementById("changePasswordErrorMessage"),h=document.getElementById("changePasswordSuccessMessage"),b=document.getElementById("paginationControls"),B=document.getElementById("prevPageBtn"),P=document.getElementById("nextPageBtn"),q=document.getElementById("currentPageInfo");let r=1;const l=10;let n=[];const m=(e,t="success")=>{let a;t==="success"?a="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?a="linear-gradient(to right, #ef4444, #dc2626)":a="linear-gradient(to right, #3b82f6, #2563eb)",$({text:e,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:a,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},z=async()=>{try{let e=d.getCurrentUser();if(!e||!e.id)return null;const t=await J.getUserByID(e.id);return t&&v&&(v.src=t.photo||"https://via.placeholder.com/40x40/E2E8F0/4A5568?text=ME",v.alt=t.name),t}catch(e){return console.error("Error fetching employee profile data for header:",e),e.status===401||e.status===403?(m("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>d.logout(),2e3)):m(e.message||"Gagal memuat data profil header.","error"),null}},R=async()=>{p.innerHTML=`
            <tr>
                <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat riwayat absensi...</td>
            </tr>
        `,w.classList.add("hidden"),b.classList.add("hidden");try{const e=d.getCurrentUser();if(!e||e.role!=="karyawan"){m("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>d.logout(),2e3);return}let t=await j.getMyHistory();Array.isArray(t)||(console.warn("Peringatan: API /attendance/my-history tidak mengembalikan array. Menerima:",t),t=[],m("Peringatan: Format data riwayat absensi tidak valid dari server.","info")),n=t,n.sort((a,i)=>new Date(i.date)-new Date(a.date)),n.length===0?(p.innerHTML=`
                    <tr>
                        <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada riwayat absensi yang ditemukan.</td>
                    </tr>
                `,w.textContent="Anda belum memiliki riwayat absensi.",w.classList.remove("hidden"),w.classList.add("info")):(I(n,r,l),T(n.length,r,l),n.length>l&&b.classList.remove("hidden"))}catch(e){console.error("Error loading attendance history:",e),p.innerHTML=`
                <tr>
                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat riwayat absensi: ${e.message}</td>
                </tr>
            `,m(e.message||"Gagal memuat riwayat absensi.","error"),(e.status===401||e.status===403)&&setTimeout(()=>d.logout(),2e3)}},I=(e,t,a)=>{p.innerHTML="";const i=(t-1)*a,x=i+a;e.slice(i,x).forEach(s=>{const K=p.insertRow(),Y=new Date(s.date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});let y=s.status||"-",u="text-gray-700";switch(s.status){case"Hadir":u="text-green-600 font-semibold";break;case"Telat":u="text-orange-600 font-semibold";break;case"Izin":u="text-purple-600 font-semibold",s.note&&(y=`Izin (${s.note})`);break;case"Sakit":u="text-red-600 font-semibold",s.note&&(y=`Sakit (${s.note})`);break;case"Cuti":u="text-blue-600 font-semibold",s.note&&(y=`Cuti (${s.note})`);break;case"Alpha":u="text-gray-500 font-semibold",s.note&&(y=`Alpha (${s.note})`);break;default:u="text-gray-900"}K.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${Y}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${s.check_in||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${s.check_out||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${u}">${y}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${s.note||"-"}</td>
            `})},T=(e,t,a)=>{const i=Math.ceil(e/a);q.textContent=`Halaman ${t} dari ${i}`,B.disabled=t===1,P.disabled=t===i||i===0,e>a?b.classList.remove("hidden"):b.classList.add("hidden")};B&&B.addEventListener("click",()=>{r>1&&(r--,I(n,r,l),T(n.length,r,l))}),P&&P.addEventListener("click",()=>{const e=Math.ceil(n.length/l);r<e&&(r++,I(n,r,l),T(n.length,r,l))});const O=()=>{E.reset(),o.classList.add("hidden"),h.classList.add("hidden"),o.textContent="",h.textContent=""};if(A&&A.addEventListener("click",e=>{e.preventDefault(),O(),c.classList.remove("hidden"),setTimeout(()=>c.classList.add("active"),10),f&&f.classList.remove("active")}),D&&D.addEventListener("click",()=>{c.classList.remove("active"),setTimeout(()=>c.classList.add("hidden"),300)}),H&&H.addEventListener("click",()=>{c.classList.remove("active"),setTimeout(()=>c.classList.add("hidden"),300)}),E&&E.addEventListener("submit",async e=>{e.preventDefault(),o.classList.add("hidden"),h.classList.add("hidden"),o.textContent="",h.textContent="";const t=N.value,a=U.value,i=G.value;if(a!==i){o.textContent="Password baru dan konfirmasi password tidak cocok.",o.classList.remove("hidden");return}if(a.length<6){o.textContent="Password baru minimal 6 karakter.",o.classList.remove("hidden");return}const x=d.getCurrentUser();if(!x||!x.id){m("Sesi tidak valid. Harap login kembali.","error"),setTimeout(()=>d.logout(),2e3);return}try{await d.changePassword(t,a),h.textContent="Password berhasil diubah!",h.classList.remove("hidden"),m("Password berhasil diubah!","success"),setTimeout(()=>{c.classList.remove("active"),setTimeout(()=>c.classList.add("hidden"),300)},1500)}catch(M){console.error("Error changing password:",M);const s=M.message||"Gagal mengubah password. Silakan coba lagi.";o.textContent=s,o.classList.remove("hidden"),m(s,"error")}}),L&&(L.addEventListener("click",()=>{f.classList.toggle("active")}),document.addEventListener("click",e=>{L.contains(e.target)||f.classList.remove("active")})),F.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),_()})}),C&&g&&k&&S){const e=()=>{g.classList.remove("hidden"),setTimeout(()=>{g.classList.add("opacity-100"),k.classList.remove("-translate-x-full")},10)},t=()=>{g.classList.remove("opacity-100"),k.classList.add("-translate-x-full"),setTimeout(()=>g.classList.add("hidden"),300)};C.addEventListener("click",e),S.addEventListener("click",t),g.addEventListener("click",a=>{a.target===g&&t()})}const _=()=>{const e=document.createElement("div");e.className="flex flex-col items-center p-2",e.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
            <div class="flex space-x-3">
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const t=$({node:e,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();e.querySelector("#confirmLogoutBtn").addEventListener("click",()=>{d.logout(),t.hideToast()}),e.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{t.hideToast()})};z(),R()});
