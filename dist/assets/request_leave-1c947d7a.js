import"./input-2b7f90d6.js";import{a as l}from"./AuthServices-0f733033.js";import{u as ne}from"./UserServices-9109671c.js";import{L as N}from"./LeaveRequestsServices-d7327dcf.js";import{T as G}from"./toastify-85d374dd.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace();const B=document.getElementById("userAvatar"),L=document.getElementById("dropdownMenu"),I=document.getElementById("userDropdown"),z=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),H=document.getElementById("sidebarToggle"),g=document.getElementById("mobileSidebar"),P=document.getElementById("mobileSidebarPanel"),q=document.getElementById("closeSidebar"),u=document.getElementById("changePasswordModal"),_=document.getElementById("openChangePasswordModalBtn"),$=document.getElementById("closeChangePasswordModalBtn"),F=document.getElementById("cancelChangePasswordBtn"),M=document.getElementById("changePasswordForm"),O=document.getElementById("oldPassword"),K=document.getElementById("newPassword"),Y=document.getElementById("confirmNewPassword"),i=document.getElementById("changePasswordErrorMessage"),h=document.getElementById("changePasswordSuccessMessage"),R=document.getElementById("leaveRequestForm"),x=document.getElementById("requestType"),J=document.getElementById("startDate"),Q=document.getElementById("endDate"),V=document.getElementById("reason"),T=document.getElementById("attachmentSection"),y=document.getElementById("attachment"),n=document.getElementById("formMessage"),v=document.getElementById("leaveHistoryTableBody"),b=document.getElementById("leaveHistoryMessage"),k=document.getElementById("paginationControls"),C=document.getElementById("prevPageBtn"),D=document.getElementById("nextPageBtn"),W=document.getElementById("currentPageInfo");let c=1;const m=5;let o=[];const r=(e,t="success")=>{let a;t==="success"?a="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?a="linear-gradient(to right, #ef4444, #dc2626)":a="linear-gradient(to right, #3b82f6, #2563eb)",G({text:e,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:a,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},X=async()=>{try{let e=l.getCurrentUser();if(!e||!e.id)return null;const t=await ne.getUserByID(e.id);return t&&B&&(B.src=t.photo||"https://via.placeholder.com/40x40/E2E8F0/4A5568?text=ME",B.alt=t.name),t}catch(e){return console.error("Error fetching employee profile data for header:",e),e.status===401||e.status===403?(r("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>l.logout(),2e3)):r(e.message||"Gagal memuat data profil header.","error"),null}},U=async()=>{v.innerHTML=`
            <tr>
                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat riwayat pengajuan...</td>
            </tr>
        `,b.classList.add("hidden"),k.classList.add("hidden");try{const e=l.getCurrentUser();if(!e||e.role!=="karyawan"){r("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>l.logout(),2e3);return}let t=await N.getMyLeaveRequests();Array.isArray(t)||(console.warn("Peringatan: API /leave-requests/my-requests tidak mengembalikan array. Menerima:",t),t=[],r("Peringatan: Format data riwayat pengajuan tidak valid dari server.","info")),o=t,o.sort((a,s)=>new Date(s.created_at)-new Date(a.created_at)),o.length===0?(v.innerHTML=`
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada riwayat pengajuan cuti/izin.</td>
                    </tr>
                `,b.textContent="Anda belum memiliki riwayat pengajuan cuti atau izin.",b.classList.remove("hidden"),b.classList.add("info")):(S(o,c,m),j(o.length,c,m),o.length>m&&k.classList.remove("hidden"))}catch(e){console.error("Error loading leave history:",e),v.innerHTML=`
                <tr>
                    <td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat riwayat pengajuan: ${e.message}</td>
                </tr>
            `,r(e.message||"Gagal memuat riwayat pengajuan.","error"),(e.status===401||e.status===403)&&setTimeout(()=>l.logout(),2e3)}},S=(e,t,a)=>{v.innerHTML="";const s=(t-1)*a,p=s+a;e.slice(s,p).forEach(d=>{const te=v.insertRow(),ae=new Date(d.start_date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}),se=new Date(d.end_date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});let f="",E=d.status;switch(d.status){case"pending":f="text-yellow-600",E="Menunggu";break;case"approved":f="text-green-600",E="Disetujui";break;case"rejected":f="text-red-600",E="Ditolak";break;default:f="text-gray-600";break}te.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ae}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${se}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${d.request_type||"-"}</td>
                <td class="px-6 py-4 text-sm text-gray-700 max-w-xs overflow-hidden text-ellipsis">${d.reason||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${f} font-semibold">${E}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    ${d.attachment_url?`<a href="${d.attachment_url}" target="_blank" class="text-teal-600 hover:underline">Lihat Lampiran</a>`:"-"}
                </td>
            `})},j=(e,t,a)=>{const s=Math.ceil(e/a);W.textContent=`Halaman ${t} dari ${s}`,C.disabled=t===1,D.disabled=t===s||s===0,e>a?k.classList.remove("hidden"):k.classList.add("hidden")};C&&C.addEventListener("click",()=>{c>1&&(c--,S(o,c,m),j(o.length,c,m))}),D&&D.addEventListener("click",()=>{const e=Math.ceil(o.length/m);c<e&&(c++,S(o,c,m),j(o.length,c,m))}),x.addEventListener("change",()=>{x.value==="Sakit"?(T.classList.remove("hidden"),y.setAttribute("required","required")):(T.classList.add("hidden"),y.removeAttribute("required"),y.value="")});let w=!1;R.addEventListener("submit",async e=>{if(e.preventDefault(),w)return;w=!0,n.classList.add("hidden"),n.textContent="";const t=new FormData;t.append("request_type",x.value),t.append("start_date",J.value),t.append("end_date",Q.value),t.append("reason",V.value);const a=y.files[0];if(a){if(a.size>2*1024*1024){r("Ukuran file terlalu besar! Maksimal 2MB.","error"),n.textContent="Ukuran file terlalu besar! Maksimal 2MB.",n.classList.remove("hidden"),n.classList.add("error"),w=!1;return}t.append("attachment",a)}else if(x.value==="Sakit"&&y.hasAttribute("required")){r("Lampiran (surat dokter) wajib untuk pengajuan Sakit.","error"),n.textContent="Lampiran (surat dokter) wajib untuk pengajuan Sakit.",n.classList.remove("hidden"),n.classList.add("error"),w=!1;return}try{const s=await N.createLeaveRequest(t);r(s.message||"Pengajuan berhasil dikirim!","success"),n.textContent="Pengajuan berhasil dikirim dan menunggu persetujuan admin.",n.classList.remove("hidden","error"),n.classList.add("success"),R.reset(),T.classList.add("hidden"),y.removeAttribute("required"),U()}catch(s){console.error("Error submitting leave request:",s);const p=s.message||"Gagal mengirim pengajuan. Silakan coba lagi.";r(p,"error"),n.textContent=p,n.classList.remove("hidden","success"),n.classList.add("error"),(s.status===401||s.status===403)&&setTimeout(()=>l.logout(),2e3)}finally{w=!1}});const Z=()=>{M.reset(),i.classList.add("hidden"),h.classList.add("hidden"),i.textContent="",h.textContent=""};if(_&&_.addEventListener("click",e=>{e.preventDefault(),Z(),u.classList.remove("hidden"),setTimeout(()=>u.classList.add("active"),10),L&&L.classList.remove("active")}),$&&$.addEventListener("click",()=>{u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)}),F&&F.addEventListener("click",()=>{u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)}),M&&M.addEventListener("submit",async e=>{e.preventDefault(),i.classList.add("hidden"),h.classList.add("hidden"),i.textContent="",h.textContent="";const t=O.value,a=K.value,s=Y.value;if(a!==s){i.textContent="Password baru dan konfirmasi password tidak cocok.",i.classList.remove("hidden");return}if(a.length<6){i.textContent="Password baru minimal 6 karakter.",i.classList.remove("hidden");return}const p=l.getCurrentUser();if(!p||!p.id){r("Sesi tidak valid. Harap login kembali.","error"),setTimeout(()=>l.logout(),2e3);return}try{await l.changePassword(t,a),h.textContent="Password berhasil diubah!",h.classList.remove("hidden"),r("Password berhasil diubah!","success"),setTimeout(()=>{u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)},1500)}catch(A){console.error("Error changing password:",A);const d=A.message||"Gagal mengubah password. Silakan coba lagi.";i.textContent=d,i.classList.remove("hidden"),r(d,"error")}}),I&&(I.addEventListener("click",()=>{L.classList.toggle("active")}),document.addEventListener("click",e=>{I.contains(e.target)||L.classList.remove("active")})),z.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),ee()})}),H&&g&&P&&q){const e=()=>{g.classList.remove("hidden"),setTimeout(()=>{g.classList.add("opacity-100"),P.classList.remove("-translate-x-full")},10)},t=()=>{g.classList.remove("opacity-100"),P.classList.add("-translate-x-full"),setTimeout(()=>g.classList.add("hidden"),300)};H.addEventListener("click",e),q.addEventListener("click",t),g.addEventListener("click",a=>{a.target===g&&t()})}const ee=()=>{const e=document.createElement("div");e.className="flex flex-col items-center p-2",e.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
            <div class="flex space-x-3">
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const t=G({node:e,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();e.querySelector("#confirmLogoutBtn").addEventListener("click",()=>{l.logout(),t.hideToast()}),e.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{t.hideToast()})};X(),U()});
