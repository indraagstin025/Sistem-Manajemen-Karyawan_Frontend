import"./input-119a5317.js";import{a as j}from"./AuthServices-f47c4eb9.js";import{L as z}from"./LeaveRequestsServices-ddeca199.js";import{T as ne}from"./toastify-3acd0462.js";/* empty css                 */import{i as se,S as ie}from"./logoutHandler-87b1a96c.js";import{g as oe}from"./photoUtils-240b8068.js";const re="https://sistem-manajemen-karyawanbackend-production.up.railway.app",le=i=>i?i.startsWith("http://")||i.startsWith("https://")?i:`${re}${i}`:null,u=(i,M="success")=>{let g;M==="success"?g="linear-gradient(to right, #22c55e, #16a34a)":M==="error"?g="linear-gradient(to right, #ef4444, #dc2626)":g="linear-gradient(to right, #3b82f6, #2563eb)",ne({text:i,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:g,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},de=()=>{ie.fire({title:"Anda yakin ingin keluar?",text:"Anda akan diarahkan ke halaman login.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, Keluar",cancelButtonText:"Batal"}).then(i=>{i.isConfirmed&&j.logout()})};document.addEventListener("DOMContentLoaded",()=>{feather.replace();const i=document.getElementById("attachmentViewerModal"),M=document.getElementById("closeAttachmentViewerModalBtn"),g=document.getElementById("attachmentContent"),h=document.getElementById("attachmentErrorMessage"),I=document.getElementById("attachmentModalTitle"),f=document.getElementById("downloadAttachmentFromModalBtn"),P=document.getElementById("userAvatar"),D=document.getElementById("dropdownMenu"),F=document.getElementById("userDropdown"),W=document.getElementById("sidebarToggle"),k=document.getElementById("mobileSidebar"),G=document.getElementById("mobileSidebarPanel"),Y=document.getElementById("closeSidebar"),C=document.getElementById("leaveRequestForm"),y=document.getElementById("requestType"),x=document.getElementById("startDate"),w=document.getElementById("endDate"),O=document.getElementById("endDateField");document.getElementById("reason");const V=document.getElementById("attachmentSection"),T=document.getElementById("attachment"),Q=document.getElementById("formMessage"),$=document.getElementById("leaveHistoryTableBody");document.getElementById("leaveHistoryMessage");const q=document.getElementById("paginationControls"),A=document.getElementById("prevPageBtn"),U=document.getElementById("nextPageBtn"),X=document.getElementById("currentPageInfo"),H=document.getElementById("leaveLimitSummary");let p=1;const E=5;let b=[],S=!1;const Z=async e=>{const t=e.target.closest(".view-attachment-btn");if(!t)return;const n=t.dataset.url;if(g.innerHTML="Memuat lampiran...",h.classList.add("hidden"),f.classList.add("hidden"),I.textContent="Lihat Lampiran: Memuat...",i.classList.remove("hidden"),setTimeout(()=>{i.classList.add("active"),document.getElementById("attachmentModalContent").classList.add("active")},10),!n){I.textContent="Lihat Lampiran: Gagal",h.textContent="URL lampiran tidak ditemukan.",h.classList.remove("hidden"),u("URL lampiran tidak ditemukan.","error");return}const s=localStorage.getItem("token");if(!s){I.textContent="Lihat Lampiran: Gagal",h.textContent="Sesi tidak valid. Harap login ulang.",h.classList.remove("hidden"),u("Sesi tidak valid. Harap login ulang.","error");return}try{const o=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(!o.ok){const a=await o.text();let l=`Gagal memuat lampiran: ${o.status}`;try{l=JSON.parse(a).message||l}catch{l=`${l} - ${a.substring(0,100)}...`}throw new Error(l)}let d="File Lampiran";const c=o.headers.get("Content-Disposition");if(c&&c.includes("filename=")){const a=c.match(/filename="?(.+)"?/);a&&a[1]&&(d=a[1].replace(/['"]/g,""))}else{const a=n.split("/");d=a[a.length-1].split("?")[0]||"file"}I.textContent=`Lihat Lampiran: ${d}`;const r=await o.blob(),L=URL.createObjectURL(r),B=o.headers.get("Content-Type")||r.type;if(g.innerHTML="",B.startsWith("image/")){const a=document.createElement("img");a.src=L,a.alt=d,a.className="max-w-full max-h-full object-contain mx-auto",g.appendChild(a),f.classList.remove("hidden"),f.onclick=()=>_({target:{dataset:{url:n,filename:d}}})}else if(B==="application/pdf"){const a=document.createElement("iframe");a.src=L,a.style.width="100%",a.style.height="100%",a.style.border="none",a.setAttribute("allowfullscreen",""),g.appendChild(a),f.classList.remove("hidden"),f.onclick=()=>_({target:{dataset:{url:n,filename:d}}})}else h.textContent=`Tipe file '${B||"tidak diketahui"}' tidak didukung untuk tampilan langsung. Silakan unduh.`,h.classList.remove("hidden"),f.classList.remove("hidden"),f.onclick=()=>_({target:{dataset:{url:n,filename:d}}});i.addEventListener("transitionend",function a(){i.classList.contains("hidden")&&(URL.revokeObjectURL(L),i.removeEventListener("transitionend",a))},{once:!0})}catch(o){I.textContent="Lihat Lampiran: Gagal",console.error("Gagal memuat lampiran untuk tampilan:",o),g.innerHTML="",h.textContent=o.message||"Terjadi kesalahan saat memuat lampiran.",h.classList.remove("hidden"),f.classList.add("hidden"),u(o.message||"Gagal memuat lampiran.","error"),i.classList.remove("active"),document.getElementById("attachmentModalContent").classList.remove("active"),setTimeout(()=>i.classList.add("hidden"),300)}},_=async e=>{const t=e.target.closest(".download-btn")||document.getElementById("downloadAttachmentFromModalBtn"),n=t.dataset.url,s=t.dataset.filename;if(!n){u("URL lampiran tidak ditemukan.","error");return}const o=localStorage.getItem("token");if(!o){u("Sesi tidak valid. Silakan login ulang.","error");return}const d=t.textContent;t.disabled=!0,t.textContent="Mengunduh...";try{const c=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${o}`}});if(!c.ok){const m=await c.text();let v=`Gagal mengunduh file: ${c.status}`;try{v=JSON.parse(m).message||v}catch{v=`${v} - ${m.substring(0,100)}...`}throw new Error(v)}const r=c.headers.get("Content-Disposition");let L="file";if(r&&r.includes("filename=")){const m=r.match(/filename="?(.+)"?/);m&&m[1]&&(L=m[1].replace(/['"]/g,""))}else if(s)L=s;else{const m=n.split("/");L=m[m.length-1].split("?")[0]}const B=await c.blob(),a=URL.createObjectURL(B),l=document.createElement("a");l.href=a,l.download=L,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(a),u("File berhasil diunduh!","success")}catch(c){console.error("Gagal mengunduh file:",c),u(c.message||"Terjadi kesalahan saat mengunduh file.","error")}finally{t.disabled=!1,t.textContent=d}},J=(e,t,n)=>{const s=document.getElementById("leaveHistoryTableBody");if(!s){console.error("Elemen leaveHistoryTableBody tidak ditemukan!");return}s.innerHTML="";const o=(t-1)*n,d=o+n,c=e.slice(o,d);if(c.length===0){s.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Tidak ada riwayat pengajuan.</td></tr>';return}c.forEach(r=>{const L=s.insertRow(),B=new Date(r.start_date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}),a=r.start_date!==r.end_date?new Date(r.end_date+"T00:00:00").toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}):"-";let l="",m=r.status;switch(r.status){case"pending":l="text-yellow-600",m="Menunggu";break;case"approved":l="text-green-600",m="Disetujui";break;case"rejected":l="text-red-600",m="Ditolak";break;case"completed":l="text-blue-600",m="Selesai";break;default:l="text-gray-600";break}const v=le(r.attachment_url),R=r.attachment_url?r.attachment_url.split("/").pop().split("?")[0]:"",ae=v?`<div class="flex items-center space-x-2">
                            <button class="view-attachment-btn text-teal-600 hover:underline focus:outline-none" data-url="${v}" data-filename="${R}">Lihat</button>
                            <button class="download-btn text-gray-500 hover:text-gray-700" data-url="${v}" data-filename="${R}" title="Unduh Lampiran">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-4.5-4.5 3 3m0 0L12 21m-4.5-4.5 3-3m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                        </div>`:"-";L.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${B}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${a}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${r.request_type||"-"}</td>
                <td class="px-6 py-4 text-sm text-gray-700 max-w-xs overflow-hidden text-ellipsis">${r.reason||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${l} font-semibold">${m}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    ${ae}
                </td>
            `})},N=(e,t,n)=>{const s=Math.ceil(e/n);if(s<=1){q.classList.add("hidden");return}q.classList.remove("hidden"),X.textContent=`Halaman ${t} dari ${s}`,A.disabled=t===1,U.disabled=t===s},ee=e=>{if(!H||!e)return;const t=new Date().getFullYear();let n=`Anda sudah mengajukan <span class="font-bold">${e.annual_leave_count}</span> kali cuti di tahun ${t}. (Batas: 12 kali)`,s="text-gray-700";e.annual_leave_count>=12?(n=`<span class="font-bold text-red-600">Anda telah mencapai batas maksimal 12 kali pengajuan cuti untuk tahun ${t}.</span>`,s="text-red-600"):e.annual_leave_count>=10&&(s="text-orange-500"),H.innerHTML=`<p class="${s}">ðŸ“… ${n}</p><p class="text-sm text-gray-500 mt-2">Catatan: Pengajuan cuti dapat dilakukan berkali-kali dalam sebulan selama kuota tahunan masih ada.</p>`,H.classList.remove("hidden")},te=()=>{if(A==null||A.addEventListener("click",()=>{p>1&&(p--,J(b,p,E),N(b.length,p,E))}),U==null||U.addEventListener("click",()=>{const e=Math.ceil(b.length/E);p<e&&(p++,J(b,p,E),N(b.length,p,E))}),y==null||y.addEventListener("change",()=>{const e=y.value;e==="Sakit"?(V.classList.remove("hidden"),T.setAttribute("required","required"),O.classList.remove("hidden"),w.removeAttribute("disabled")):e==="Cuti"?(V.classList.add("hidden"),T.removeAttribute("required"),T.value="",O.classList.add("hidden"),w.setAttribute("disabled","disabled"),x.value&&(w.value=x.value)):(V.classList.add("hidden"),T.removeAttribute("required"),T.value="",O.classList.remove("hidden"),w.removeAttribute("disabled"))}),x==null||x.addEventListener("change",()=>{y.value==="Cuti"&&(w.value=x.value)}),C==null||C.addEventListener("submit",async e=>{if(e.preventDefault(),S)return;S=!0,Q.classList.add("hidden");const t=y.value,n=x.value;let s=w.value;if(t==="Cuti"&&(s=n,w.value=n),new Date(n)>new Date(s)){u("Tanggal selesai tidak boleh sebelum tanggal mulai.","error"),S=!1;return}if(!t||!n||!s||t==="Sakit"&&!T.files[0]){u("Mohon lengkapi semua field yang diperlukan, termasuk lampiran untuk Sakit.","error"),S=!1;return}const o=new FormData(C);o.set("end_date",s);try{const d=await z.createLeaveRequest(o);u(d.message||"Pengajuan berhasil dikirim!","success"),C.reset(),y.dispatchEvent(new Event("change")),await K()}catch(d){const c=d.message||"Gagal mengirim pengajuan.";u(c,"error")}finally{S=!1}}),F==null||F.addEventListener("click",e=>{e.stopPropagation(),D.classList.toggle("active")}),document.addEventListener("click",()=>D==null?void 0:D.classList.remove("active")),se({preLogoutCallback:de}),W&&k&&G&&Y){const e=()=>{k.classList.remove("hidden"),setTimeout(()=>{k.classList.add("opacity-100"),G.classList.remove("-translate-x-full")},10)},t=()=>{k.classList.remove("opacity-100"),G.classList.add("-translate-x-full"),setTimeout(()=>k.classList.add("hidden"),300)};W.addEventListener("click",e),Y.addEventListener("click",t),k.addEventListener("click",n=>{n.target===k&&t()})}$&&$.addEventListener("click",e=>{const t=e.target;t.classList.contains("view-attachment-btn")?Z(e):t.classList.contains("download-btn")&&_(e)}),M&&(M.addEventListener("click",()=>{i.classList.remove("active"),document.getElementById("attachmentModalContent").classList.remove("active"),setTimeout(()=>{i.classList.add("hidden"),g.innerHTML="",h.classList.add("hidden"),f.classList.add("hidden")},300)}),i.addEventListener("click",e=>{e.target===i&&(i.classList.remove("active"),document.getElementById("attachmentModalContent").classList.remove("active"),setTimeout(()=>{i.classList.add("hidden"),g.innerHTML="",h.classList.add("hidden"),f.classList.add("hidden")},300))}))},K=async()=>{$.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Memuat data...</td></tr>',H.innerHTML='<p class="text-gray-500">Memuat info...</p>';try{const e=j.getCurrentUser();if(!e||e.role!=="karyawan"){u("Akses ditolak atau sesi tidak valid.","error"),j.logout();return}const[t,n,s]=await Promise.all([z.getMyLeaveRequests(),z.getLeaveSummary(),oe(e.id,e.name||"User")]);P&&(P.src=s,P.alt=e.name||"User Avatar"),ee(n),b=Array.isArray(t)?t.sort((o,d)=>new Date(d.created_at)-new Date(o.created_at)):[],p=1,J(b,p,E),N(b.length,p,E)}catch(e){console.error("Error initializing page:",e),u(e.message||"Gagal memuat data halaman.","error"),$.innerHTML=`<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Gagal memuat data: ${e.message}</td></tr>`,(e.status===401||e.status===403)&&j.logout()}};te(),K(),y.dispatchEvent(new Event("change"))});
