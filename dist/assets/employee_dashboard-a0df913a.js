import"./input-ef370086.js";import{u as q,g as H}from"./photoUtils-240b8068.js";import{a as p}from"./AuthServices-f47c4eb9.js";import{A as M}from"./AttendanceServices-f61bdc29.js";import{L as G}from"./LeaveRequestsServices-ddeca199.js";import{i as Q}from"./sidebarHandler-d6522c99.js";import{i as N,S as b}from"./logoutHandler-87b1a96c.js";import{T as _}from"./toastify-3acd0462.js";/* empty css                 */document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),Q(),N();const v=document.getElementById("profilePhoto"),E=document.getElementById("employeeName"),w=document.getElementById("employeePosition"),B=document.getElementById("employeeDepartment"),a=document.getElementById("todayAttendanceStatus"),y=document.getElementById("remainingLeave"),S=document.getElementById("userAvatar"),u=document.getElementById("dropdownMenu"),h=document.getElementById("userDropdown"),l=document.getElementById("scanQrButton"),k=document.getElementById("qrFullscreenContainer"),x=document.getElementById("readerFull"),C=document.getElementById("qrScanResultText"),I=document.getElementById("qr-scan-result"),A=document.getElementById("current-date"),d=document.getElementById("check-in-time"),s=document.getElementById("attendance-status");document.getElementById("attendance-note-display"),document.getElementById("attendance-note");let c=null,g=!1;function m(e,n,t="success",o=!1,r=2e3){b.fire({title:e,text:n,icon:t,showConfirmButton:o,timer:r,timerProgressBar:!0,didOpen:i=>{i.addEventListener("mouseenter",b.stopTimer),i.addEventListener("mouseleave",b.resumeTimer)}})}function P(e,n="success"){let t;n==="success"?t="linear-gradient(to right, #22c55e, #16a34a)":n==="error"?t="linear-gradient(to right, #ef4444, #dc2626)":t="linear-gradient(to right, #3b82f6, #2563eb)",_({text:e,duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,style:{background:t,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()}function F(e){return e||"-"}function R(e){const n=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});if(A&&(A.textContent=n),s&&(s.className=""),a&&(a.className="text-lg font-bold"),e){const t=e.status;a&&(a.textContent=t),t==="Hadir"?(a&&a.classList.add("text-green-600"),s&&s.classList.add("text-green-600","font-semibold")):t==="Terlambat"?(a&&a.classList.add("text-orange-500"),s&&s.classList.add("text-orange-500","font-semibold")):["Sakit","Cuti"].includes(t)?(a&&a.classList.add("text-blue-600"),s&&s.classList.add("text-blue-600","font-semibold"),d&&(d.textContent="-")):(a&&a.classList.add("text-red-600"),s&&s.classList.add("text-red-600","font-semibold"),d&&(d.textContent="-")),e.check_in&&d&&(d.textContent=F(e.check_in)),s&&(s.textContent=t)}else a&&(a.textContent="Belum Absen",a.classList.add("text-red-600")),d&&(d.textContent="-"),s&&(s.textContent="Belum Absen",s.classList.add("text-red-600","font-semibold"))}async function O(e){var t,o,r;console.log(`INFO: QR Code terdeteksi, data: ${e}. Memulai proses absensi.`);const n=p.getCurrentUser();if(!n||!n.id){m("Error Autentikasi","Sesi pengguna tidak valid. Silakan login kembali.","error"),g=!1;return}try{const i=await M.scanQR(e,n.id);b.fire({title:"Absensi Berhasil!",text:i.message,icon:"success",confirmButtonText:"Selesai"}),T()}catch(i){console.error("ERROR: Gagal saat memproses absensi di server:",i);const L=((o=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:o.error)||i.message||"Terjadi kesalahan saat menghubungi server.",f=((r=i.response)==null?void 0:r.status)===409?"info":"error";m(f==="info"?"Info Absensi":"Absensi Gagal!",L,f)}finally{g=!1}}async function T(){try{const e=await M.getMyHistory(),n=new Date().toISOString().slice(0,10),t=e.find(r=>r.date===n);R(t);const o=t&&["Hadir","Terlambat","Sakit","Cuti"].includes(t.status);l&&(o?(l.disabled=!0,l.classList.add("bg-gray-400","cursor-not-allowed"),l.classList.remove("bg-indigo-600","hover:bg-indigo-700"),l.innerText="Anda Sudah Absen Hari Ini"):(l.disabled=!1,l.classList.remove("bg-gray-400","cursor-not-allowed"),l.classList.add("bg-indigo-600","hover:bg-indigo-700"),l.innerText="Scan QR Code Absensi"))}catch(e){console.error("ERROR: Gagal memuat riwayat absensi:",e),R(null),l&&(l.disabled=!1)}}const U=async()=>{try{if(!localStorage.getItem("token"))return m("Sesi Tidak Valid","Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>p.logout(),2e3),null;let n;try{if(n=p.getCurrentUser(),!n)throw new Error("Data pengguna tidak ditemukan di sesi.")}catch(r){throw console.error("Error parsing user from localStorage:",r),new Error("Data pengguna di sesi rusak.")}if(n.role!=="karyawan")return m("Akses Ditolak","Akses ditolak. Peran tidak sesuai untuk halaman ini.","error"),setTimeout(()=>p.logout(),2e3),null;const t=await q.getUserByID(n.id),o=await G.getLeaveSummary();if(t){const r=await H(n.id,t.name);if(v&&(v.src=r),S&&(S.src=r,S.alt=t.name),E&&(E.textContent=t.name),w&&(w.textContent=t.position||"-"),B&&(B.textContent=t.department||"-"),y){const L=o.annual_leave_count||0,f=Math.max(0,12-L);y.textContent=`${f} Kali`,f<=3?y.classList.add("text-red-600","font-semibold"):y.classList.remove("text-red-600","font-semibold")}}return t}catch(e){return console.error("Error fetching employee profile data:",e),m("Gagal Memuat Profil",e.message||"Gagal memuat data profil.","error"),(e.status===401||e.message&&(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Peran tidak sesuai")||e.message.includes("Data pengguna di sesi rusak")))&&setTimeout(()=>p.logout(),2e3),null}};window.openFullscreenScanner=async function(){const e=document.getElementById("closeScannerBtn");if(!k||!x||!e)return console.error("ERROR: Elemen HTML untuk scanner fullscreen tidak ditemukan.");g=!1,k.classList.remove("hidden"),x.innerHTML="",C.textContent="Memulai kamera...",c=new Html5Qrcode(x.id);try{const n=await Html5Qrcode.getCameras();if(!n||n.length===0)throw new Error("Kamera tidak ditemukan di perangkat ini.");const t=n.find(o=>/back|rear|environment/i.test(o.label))||n[n.length-1];console.log("INFO: Menggunakan kamera:",t.label),await c.start(t.id,{fps:10,qrbox:{width:250,height:250},aspectRatio:1},async(o,r)=>{g||(g=!0,c!=null&&c.isScanning&&await c.stop(),k.classList.add("hidden"),P("QR Code terbaca, memproses...","info"),O(o))},o=>{}),C.textContent="Arahkan kamera ke QR Code Absensi"}catch(n){console.error("ERROR: Gagal memulai scanner:",n),m("Gagal Membuka Kamera",n.message,"error"),k.classList.add("hidden")}},h&&(h.addEventListener("click",e=>{e.stopPropagation(),u&&u.classList.toggle("active")}),document.addEventListener("click",e=>{u&&h&&!h.contains(e.target)&&!u.contains(e.target)&&u.classList.remove("active")}));const D=document.getElementById("closeScannerBtn");D&&D.addEventListener("click",async()=>{const e=document.getElementById("qrFullscreenContainer");if(c)try{await c.stop(),console.log("Scanner fullscreen dihentikan via tombol tutup.")}catch(t){console.warn("Gagal menghentikan scanner fullscreen via tombol tutup:",t)}e&&e.classList.add("hidden");const n=document.getElementById("readerFull");n&&(n.innerHTML=""),I&&(I.textContent=""),c=null}),await U()&&T()});
