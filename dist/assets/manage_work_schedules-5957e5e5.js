import"./input-41369e4a.js";import{C as O,i as Q,a as G,b as H,l as K,W as u}from"./WorkScheduleServices-b10e58c7.js";import{a as v}from"./AuthServices-f47c4eb9.js";import{i as R}from"./sidebarHandler-d6522c99.js";import{i as z,S as I}from"./logoutHandler-87b1a96c.js";import{Q as m}from"./qrCodeHandler-01879f51.js";import{g as V}from"./photoUtils-240b8068.js";import{T as j}from"./toastify-3acd0462.js";import"./AttendanceServices-f61bdc29.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),R(),z({preLogoutCallback:()=>{typeof m<"u"&&m.close&&m.close()}}),m.initialize({toastCallback:(e,t)=>{let s;t==="success"?s="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?s="linear-gradient(to right, #ef4444, #dc2626)":s="linear-gradient(to right, #3b82f6, #2563eb)",j({text:e,duration:3e3,close:!0,gravity:"top",position:"right",style:{background:s,borderRadius:"8px"}}).showToast()}});const E=document.getElementById("scheduleFormModal"),M=document.getElementById("closeScheduleModalBtn"),w=document.getElementById("workScheduleForm"),A=document.getElementById("form-modal-title"),p=document.getElementById("schedule-id"),b=document.getElementById("schedule-date"),S=document.getElementById("start-time"),L=document.getElementById("end-time"),D=document.getElementById("note"),T=document.getElementById("save-schedule-btn"),N=document.getElementById("cancel-schedule-btn"),h=document.getElementById("delete-schedule-btn"),$=document.getElementById("manualAddScheduleBtn"),c=document.getElementById("recurrence-freq"),f=document.getElementById("weekly-options"),g=document.querySelectorAll(".weekday-checkbox"),k=document.getElementById("recurrence-until"),d=document.getElementById("userAvatar"),i=document.getElementById("userNameNav"),C=document.getElementById("userDropdown"),F=document.getElementById("dropdownMenu");let y;const l=(e,t,s="success",r=!1,a=2e3)=>{I.fire({title:e,html:t,icon:s,showConfirmButton:r,timer:a,timerProgressBar:!0,didOpen:o=>{a>0&&(o.addEventListener("mouseenter",I.stopTimer),o.addEventListener("mouseleave",I.resumeTimer))}})},Y=async()=>{try{const e=await v.getCurrentUser();if(e&&e.role==="admin"){const t=await V(e.id,e.name,40);d&&(d.src=t,d.alt=e.name||"Admin"),i&&(i.textContent=e.name||"Admin")}else d&&(d.src="/assets/default-avatar.png"),i&&(i.textContent="Guest")}catch(e){console.error("Failed to load admin profile for header:",e),d&&(d.src="/assets/default-avatar.png"),i&&(i.textContent="Error")}};c.addEventListener("change",()=>{c.value==="WEEKLY"?f.classList.remove("hidden"):(f.classList.add("hidden"),g.forEach(e=>e.checked=!1))});const P=()=>{const e=c.value;if(e==="NONE")return"";let t=`FREQ=${e}`;if(e==="WEEKLY"){const s=Array.from(g).filter(r=>r.checked).map(r=>r.value);if(s.length===0)return l("Validation Failed","Please select at least one day for weekly schedule.","warning"),"";t+=`;BYDAY=${s.join(",")}`}if(k.value){const s=k.value.replace(/-/g,"");t+=`;UNTIL=${s}T235959Z`}return t},x=(e="create",t=null)=>{if(E.classList.remove("hidden"),setTimeout(()=>E.classList.add("active"),10),h.classList.add("hidden"),e==="create")A.textContent="Add Work Schedule",w.reset(),f.classList.add("hidden"),p.value="",b.value=new Date().toISOString().split("T")[0],S.value="09:00",L.value="17:00",g.forEach(s=>s.checked=!1),c.value="NONE",k.value="";else if(e==="edit"&&t){A.textContent="Edit Work Schedule Rule",p.value=t.id,b.value=t.date,S.value=t.start_time.substring(0,5),L.value=t.end_time.substring(0,5),D.value=t.note||"";const s=t.recurrence_rule?t.recurrence_rule.split(";"):[];let r="NONE",a=[],o="";s.forEach(n=>{n.startsWith("FREQ=")?r=n.replace("FREQ=",""):n.startsWith("BYDAY=")?a=n.replace("BYDAY=","").split(","):n.startsWith("UNTIL=")&&(o=n.replace("UNTIL=","").substring(0,8))}),c.value=r,r==="WEEKLY"?(f.classList.remove("hidden"),g.forEach(n=>{n.checked=a.includes(n.value)})):(f.classList.add("hidden"),g.forEach(n=>n.checked=!1)),k.value=o?`${o.substring(0,4)}-${o.substring(4,6)}-${o.substring(6,8)}`:"",h.classList.remove("hidden")}},B=()=>{E.classList.remove("active"),setTimeout(()=>{E.classList.add("hidden"),w.reset()},300)},U=document.getElementById("calendar");y=new O(U,{plugins:[Q,G,H],initialView:"dayGridMonth",locale:K,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},editable:!0,selectable:!0,displayEventTime:!1,eventSources:[{events:async e=>{try{const t={start_date:e.startStr.split("T")[0],end_date:e.endStr.split("T")[0]};return((await u.getAllWorkSchedules(t)).data||[]).map(r=>({id:r.id,title:`${r.start_time.substring(0,5)} - ${r.end_time.substring(0,5)}`,start:r.date,extendedProps:{start_time:r.start_time,end_time:r.end_time,note:r.note,recurrence_rule:r.recurrence_rule},allDay:!0,color:"#38b2ac",textColor:"white",display:"block"}))}catch(t){return console.error("Error fetching work schedules:",t),l("Error Fetching Schedules",`Failed to load work schedules: ${t.message||"An error occurred."}`,"error",!0),(t.status===401||t.status===403)&&setTimeout(()=>v.logout(),2e3),[]}},color:"#38b2ac",textColor:"white"},{events:async e=>{try{const t=e.start.getFullYear();return(await u.getHolidays(t)||[]).map(r=>({title:r.Name,start:r.Date,allDay:!0,display:"background",color:"#ff9f89"}))}catch(t){return console.error("Error fetching holidays:",t),l("Error Fetching Holidays",`Failed to load holidays: ${t.message||"An error occurred."}`,"error",!0),[]}}}],select:e=>{x("create"),b.value=e.startStr.split("T")[0],y.unselect()},eventClick:async e=>{const t=e.event.id;if(e.event.display==="background"){l("Holiday Info",`Holiday: ${e.event.title}`,"info");return}try{const r=(await u.getWorkScheduleById(t)).data;r?x("edit",r):l("Data Not Found","Schedule details not found.","error")}catch(s){console.error("Error fetching schedule for edit:",s),l("Failed to Load Schedule",`Failed to load schedule details for editing: ${s.message||"An error occurred."}`,"error",!0),(s.status===401||s.status===403)&&setTimeout(()=>v.logout(),2e3)}}}),y.render(),$.addEventListener("click",()=>x("create")),M.addEventListener("click",B),N.addEventListener("click",B);const W=document.getElementById("generate-qr-menu-btn"),_=document.getElementById("generate-qr-menu-btn-mobile");W&&W.addEventListener("click",()=>m.open()),_&&_.addEventListener("click",()=>{const e=document.getElementById("mobileSidebar"),t=document.getElementById("mobileSidebarPanel");e&&t&&(e.classList.remove("opacity-100"),t.classList.add("-translate-x-full"),setTimeout(()=>{e.classList.add("hidden")},300)),m.open()}),C&&(C.addEventListener("click",e=>{e.stopPropagation(),F.classList.toggle("active")}),document.addEventListener("click",e=>{C.contains(e.target)||F.classList.remove("active")})),w.addEventListener("submit",async e=>{var a,o;e.preventDefault(),T.disabled=!0;const t=p.value,s=P();if(c.value==="WEEKLY"&&!s){T.disabled=!1;return}const r={date:b.value,start_time:S.value,end_time:L.value,note:D.value,recurrence_rule:s};try{t?(await u.updateWorkSchedule(t,r),l("Success!","Work schedule rule successfully updated!","success",!1,1500)):(await u.createWorkSchedule(r),l("Success!","Work schedule rule successfully saved!","success",!1,1500)),B(),y.refetchEvents()}catch(n){console.error("Error saving/updating work schedule:",n);const q=((o=(a=n.response)==null?void 0:a.data)==null?void 0:o.error)||n.message||"An error occurred while saving/updating the schedule.";l("Failed!",q,"error",!0),(n.status===401||n.status===403)&&setTimeout(()=>v.logout(),2e3)}finally{T.disabled=!1}}),h.addEventListener("click",async()=>{const e=p.value;e&&I.fire({title:"Are you sure you want to delete?",text:"This schedule rule will be permanently deleted, including all future occurrences.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, Delete!",cancelButtonText:"Cancel"}).then(async t=>{var s,r;if(t.isConfirmed){h.disabled=!0;try{await u.deleteWorkSchedule(e),l("Deleted!","Work schedule rule successfully deleted!","success",!1,1500),B(),y.refetchEvents()}catch(a){console.error("Error deleting work schedule:",a);const o=((r=(s=a.response)==null?void 0:s.data)==null?void 0:r.error)||a.message||"An error occurred while deleting the schedule.";l("Failed!",o,"error",!0),(a.status===401||a.status===403)&&setTimeout(()=>v.logout(),2e3)}finally{h.disabled=!1}}})}),Y()});
