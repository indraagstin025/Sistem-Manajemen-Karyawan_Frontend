import"./input-2ed11044.js";import{u as F,g as q}from"./photoUtils-240b8068.js";import{a as p}from"./AuthServices-f47c4eb9.js";import{A as M}from"./AttendanceServices-f61bdc29.js";import{L as H}from"./LeaveRequestsServices-ddeca199.js";import{i as O}from"./sidebarHandler-d6522c99.js";import{i as N,S as b}from"./logoutHandler-87b1a96c.js";import{T as _}from"./toastify-3acd0462.js";/* empty css                 */document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),O(),N();const L=document.getElementById("profilePhoto"),v=document.getElementById("employeeName"),B=document.getElementById("employeePosition"),w=document.getElementById("employeeDepartment"),a=document.getElementById("todayAttendanceStatus"),y=document.getElementById("remainingLeave"),S=document.getElementById("userAvatar"),m=document.getElementById("dropdownMenu"),k=document.getElementById("userDropdown"),l=document.getElementById("scanQrButton"),h=document.getElementById("qrFullscreenContainer"),E=document.getElementById("readerFull"),C=document.getElementById("qrScanResultText"),A=document.getElementById("qr-scan-result"),I=document.getElementById("current-date"),d=document.getElementById("check-in-time"),s=document.getElementById("attendance-status");document.getElementById("attendance-note-display"),document.getElementById("attendance-note");let c=null,g=!1;function u(e,n,t="success",o=!1,i=2e3){b.fire({title:e,text:n,icon:t,showConfirmButton:o,timer:i,timerProgressBar:!0,didOpen:r=>{r.addEventListener("mouseenter",b.stopTimer),r.addEventListener("mouseleave",b.resumeTimer)}})}function U(e,n="success"){let t;n==="success"?t="linear-gradient(to right, #22c55e, #16a34a)":n==="error"?t="linear-gradient(to right, #ef4444, #dc2626)":t="linear-gradient(to right, #3b82f6, #2563eb)",_({text:e,duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,style:{background:t,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()}function G(e){return e||"-"}function R(e){const n=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});if(I&&(I.textContent=n),s&&(s.className=""),a&&(a.className="text-lg font-bold"),e){const t=e.status;a&&(a.textContent=t),t==="Hadir"?(a&&a.classList.add("text-green-600"),s&&s.classList.add("text-green-600","font-semibold")):t==="Terlambat"?(a&&a.classList.add("text-orange-500"),s&&s.classList.add("text-orange-500","font-semibold")):["Sakit","Cuti"].includes(t)?(a&&a.classList.add("text-blue-600"),s&&s.classList.add("text-blue-600","font-semibold"),d&&(d.textContent="-")):(a&&a.classList.add("text-red-600"),s&&s.classList.add("text-red-600","font-semibold"),d&&(d.textContent="-")),e.check_in&&d&&(d.textContent=G(e.check_in)),s&&(s.textContent=t)}else a&&(a.textContent="Belum Absen",a.classList.add("text-red-600")),d&&(d.textContent="-"),s&&(s.textContent="Belum Absen",s.classList.add("text-red-600","font-semibold"))}async function P(e){var t,o,i;console.log(`INFO: QR Code terdeteksi, data: ${e}. Memulai proses absensi.`);const n=p.getCurrentUser();if(!n||!n.id){u("Error Autentikasi","Sesi pengguna tidak valid. Silakan login kembali.","error"),g=!1;return}try{console.log("DEBUG: Memulai panggilan AttendanceService.scanQR...");const r=await M.scanQR(e,n.id);console.log("DEBUG: AttendanceService.scanQR berhasil. Respons:",r),b.fire({title:"Absensi Berhasil!",text:r.message,icon:"success",confirmButtonText:"Selesai"}),console.log("DEBUG: Swal.fire untuk sukses dipanggil."),D()}catch(r){console.error("DEBUG: AttendanceService.scanQR GAGAL. Error:",r);const x=((o=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:o.error)||r.message||"Terjadi kesalahan saat menghubungi server.",f=((i=r.response)==null?void 0:i.status)===409?"info":"error";u(f==="info"?"Info Absensi":"Absensi Gagal!",x,f),console.log("DEBUG: showSweetAlert untuk error dipanggil.")}finally{g=!1,console.log("DEBUG: isProcessingScan diatur ke false.")}}async function D(){try{const e=await M.getMyHistory(),n=new Date().toISOString().slice(0,10),t=e.find(i=>i.date===n);R(t);const o=t&&["Hadir","Terlambat","Sakit","Cuti"].includes(t.status);l&&(o?(l.disabled=!0,l.classList.add("bg-gray-400","cursor-not-allowed"),l.classList.remove("bg-indigo-600","hover:bg-indigo-700"),l.innerText="Anda Sudah Absen Hari Ini"):(l.disabled=!1,l.classList.remove("bg-gray-400","cursor-not-allowed"),l.classList.add("bg-indigo-600","hover:bg-indigo-700"),l.innerText="Scan QR Code Absensi"))}catch(e){console.error("ERROR: Gagal memuat riwayat absensi:",e),R(null),l&&(l.disabled=!1)}}const Q=async()=>{try{if(!localStorage.getItem("token"))return u("Sesi Tidak Valid","Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>p.logout(),2e3),null;let n;try{if(n=p.getCurrentUser(),!n)throw new Error("Data pengguna tidak ditemukan di sesi.")}catch(i){throw console.error("Error parsing user from localStorage:",i),new Error("Data pengguna di sesi rusak.")}if(n.role!=="karyawan")return u("Akses Ditolak","Akses ditolak. Peran tidak sesuai untuk halaman ini.","error"),setTimeout(()=>p.logout(),2e3),null;const t=await F.getUserByID(n.id),o=await H.getLeaveSummary();if(t){const i=await q(n.id,t.name);if(L&&(L.src=i),S&&(S.src=i,S.alt=t.name),v&&(v.textContent=t.name),B&&(B.textContent=t.position||"-"),w&&(w.textContent=t.department||"-"),y){const x=o.annual_leave_count||0,f=Math.max(0,12-x);y.textContent=`${f} Kali`,f<=3?y.classList.add("text-red-600","font-semibold"):y.classList.remove("text-red-600","font-semibold")}}return t}catch(e){return console.error("Error fetching employee profile data:",e),u("Gagal Memuat Profil",e.message||"Gagal memuat data profil.","error"),(e.status===401||e.message&&(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Peran tidak sesuai")||e.message.includes("Data pengguna di sesi rusak")))&&setTimeout(()=>p.logout(),2e3),null}};window.openFullscreenScanner=async function(){const e=document.getElementById("closeScannerBtn");if(!h||!E||!e)return console.error("ERROR: Elemen HTML untuk scanner fullscreen tidak ditemukan.");g=!1,h.classList.remove("hidden"),E.innerHTML="",C.textContent="Memulai kamera...",c=new Html5Qrcode(E.id);try{const n=await Html5Qrcode.getCameras();if(!n||n.length===0)throw new Error("Kamera tidak ditemukan di perangkat ini.");const t=n.find(o=>/back|rear|environment/i.test(o.label))||n[n.length-1];console.log("INFO: Menggunakan kamera:",t.label),await c.start(t.id,{fps:10,qrbox:{width:250,height:250},aspectRatio:1},async(o,i)=>{g||(g=!0,c!=null&&c.isScanning&&await c.stop(),h.classList.add("hidden"),U("QR Code terbaca, memproses...","info"),P(o))},o=>{}),C.textContent="Arahkan kamera ke QR Code Absensi"}catch(n){console.error("ERROR: Gagal memulai scanner:",n),u("Gagal Membuka Kamera",n.message,"error"),h.classList.add("hidden")}},k&&(k.addEventListener("click",e=>{e.stopPropagation(),m&&m.classList.toggle("active")}),document.addEventListener("click",e=>{m&&k&&!k.contains(e.target)&&!m.contains(e.target)&&m.classList.remove("active")}));const T=document.getElementById("closeScannerBtn");T&&T.addEventListener("click",async()=>{const e=document.getElementById("qrFullscreenContainer");if(c)try{await c.stop(),console.log("Scanner fullscreen dihentikan via tombol tutup.")}catch(t){console.warn("Gagal menghentikan scanner fullscreen via tombol tutup:",t)}e&&e.classList.add("hidden");const n=document.getElementById("readerFull");n&&(n.innerHTML=""),A&&(A.textContent=""),c=null}),await Q()&&D()});
