import"../input-214ac174.js";import{u as _}from"../UserServices-eeba983d.js";import{a as m}from"../AuthServices-170aab02.js";import{A as Q}from"../AttendanceServices-12620ccf.js";import{T as q}from"../toastify-85d374dd.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace();const B=document.getElementById("profilePhoto"),F=document.getElementById("employeeName"),O=document.getElementById("employeePosition"),z=document.getElementById("employeeDepartment"),u=document.getElementById("todayAttendanceStatus"),I=document.getElementById("remainingLeave"),p=document.getElementById("userAvatar"),L=document.getElementById("dropdownMenu"),v=document.getElementById("userDropdown"),K=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),P=document.getElementById("sidebarToggle"),f=document.getElementById("mobileSidebar"),E=document.getElementById("mobileSidebarPanel"),T=document.getElementById("closeSidebar"),g=document.getElementById("changePasswordModal"),M=document.getElementById("openChangePasswordModalBtn"),D=document.getElementById("closeChangePasswordModalBtn"),A=document.getElementById("cancelChangePasswordBtn"),C=document.getElementById("changePasswordForm"),j=document.getElementById("oldPassword"),Y=document.getElementById("newPassword"),J=document.getElementById("confirmNewPassword"),d=document.getElementById("changePasswordErrorMessage"),y=document.getElementById("changePasswordSuccessMessage"),h=document.getElementById("reader"),c=document.getElementById("qr-scan-result");document.getElementById("notification-message");const n=document.getElementById("camera-select");let o;const U=document.getElementById("current-date"),b=document.getElementById("check-in-time"),l=document.getElementById("attendance-status"),x=document.getElementById("check-out-display"),H=document.getElementById("check-out-time"),S=document.getElementById("attendance-note-display"),N=document.getElementById("attendance-note"),r=(e,s="success")=>{let a;s==="success"?a="linear-gradient(to right, #22c55e, #16a34a)":s==="error"?a="linear-gradient(to right, #ef4444, #dc2626)":a="linear-gradient(to right, #3b82f6, #2563eb)",q({text:e,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:a,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},V=async()=>{try{if(!localStorage.getItem("token"))return r("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>m.logout(),2e3),null;let s;try{if(s=m.getCurrentUser(),!s)throw new Error("Data pengguna tidak ditemukan di sesi.")}catch(t){throw console.error("Error parsing user from localStorage:",t),new Error("Data pengguna di sesi rusak.")}if(s.role!=="karyawan")return r("Akses ditolak. Peran tidak sesuai untuk halaman ini.","error"),setTimeout(()=>m.logout(),2e3),null;const a=await _.getUserByID(s.id);if(a){try{const t=await _.getProfilePhoto(s.id),i=URL.createObjectURL(t);B.src=i,p&&(p.src=i,p.alt=a.name)}catch{const t="https://via.placeholder.com/80/4A5568/E2E8F0?text=ME";B.src=t,p&&(p.src=t,p.alt=a.name)}F.textContent=a.name,O.textContent=a.position||"-",z.textContent=a.department||"-",a.annual_leave_balance!==void 0&&a.annual_leave_balance!==null?I.textContent=`${a.annual_leave_balance} Hari`:I.textContent="N/A"}return a}catch(e){return console.error("Error fetching employee profile data:",e),r(e.message||"Gagal memuat data profil.","error"),(e.status===401||e.message&&(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Peran tidak sesuai")||e.message.includes("Data pengguna di sesi rusak")))&&setTimeout(()=>m.logout(),2e3),null}},R=e=>e||"-",W=e=>{const s=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});U.textContent=s,l.className="",u.classList.remove("text-gray-900","text-green-600","text-red-600","text-orange-600"),e?(u.textContent=e.status,e.status==="Hadir"?u.classList.add("text-green-600"):e.status==="Telat"?u.classList.add("text-orange-600"):e.status==="Sakit"||e.status==="Cuti"?u.classList.add("text-blue-600"):u.classList.add("text-gray-900"),b.textContent=R(e.check_in),l.textContent=e.status,e.status==="Hadir"?l.classList.add("text-green-600","font-semibold"):e.status==="Telat"?l.classList.add("text-orange-600","font-semibold"):e.status==="Sakit"||e.status==="Cuti"?(b.textContent="-",l.classList.add("text-blue-600","font-semibold"),x.classList.add("hidden")):l.classList.add("text-gray-600","font-semibold"),e.check_out?(x.classList.remove("hidden"),H.textContent=R(e.check_out)):(x.classList.add("hidden"),H.textContent=""),e.note?(S.classList.remove("hidden"),N.textContent=e.note):(S.classList.add("hidden"),N.textContent="")):(u.textContent="Belum Absen",u.classList.add("text-red-600"),b.textContent="-",l.textContent="Belum Absen",l.classList.add("text-red-600","font-semibold"),x.classList.add("hidden"),S.classList.add("hidden"))},G=async()=>{const e=m.getCurrentUser();if(!e||!e.id){r("Gagal memuat status absensi: User tidak terautentikasi.","error");return}try{const s=await Q.getMyHistory(),a=new Date().toISOString().slice(0,10),t=s.find(i=>i.date===a);W(t),t&&(t.status==="Hadir"||t.status==="Telat")?(o&&o.isScanning&&(await o.stop(),r("Anda sudah check-in hari ini.","info")),h&&(h.innerHTML='<p class="text-gray-500 mt-8">Anda sudah absen hari ini.</p>',c.textContent=""),n&&n.classList.add("hidden")):t&&(t.status==="Sakit"||t.status==="Cuti")?(o&&o.isScanning&&(await o.stop(),r(`Status Anda hari ini: ${t.status}.`,"info")),h&&(h.innerHTML=`<p class="text-gray-500 mt-8">Status Anda hari ini: ${t.status}.</p>`,c.textContent=""),n&&n.classList.add("hidden")):k()}catch(s){console.error("Error loading my today attendance:",s),r(`Gagal memuat status absensi: ${s.message}`,"error"),U.textContent=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}),b.textContent="Gagal memuat",l.textContent="Error",l.classList.add("text-red-600","font-semibold"),k()}},X=async(e,s)=>{console.log(`QR Code terdeteksi: ${e}`),c.textContent=`Memindai: ${e}`,o&&o.isScanning&&await o.stop();const a=m.getCurrentUser();if(!a||!a.id){r("User tidak terautentikasi. Silakan login kembali.","error"),c.textContent="Error: User tidak terautentikasi.",k();return}try{const t=await Q.scanQR(e,a.id);r(t.message,"success"),c.textContent=t.message,G()}catch(t){console.error("Error saat memindai QR Code:",t),r(`Absensi gagal: ${t.message}`,"error"),c.textContent=`Gagal Absen: ${t.message}`,k()}},Z=e=>{},k=async()=>{if(!h){console.error("QR scanner container #reader not found."),r("Gagal memulai scanner: Elemen HTML tidak ditemukan.","error");return}h.innerHTML="",c.textContent="";try{const e=await Html5Qrcode.getCameras();if(e&&e.length>0){let s=e[0].id;if(e.length>1){n&&n.classList.remove("hidden"),n&&(n.innerHTML=""),e.forEach(t=>{const i=document.createElement("option");i.value=t.id,i.textContent=t.label||`Kamera ${t.id}`,n&&n.appendChild(i)});const a=e.find(t=>t.label.toLowerCase().includes("back")||t.label.toLowerCase().includes("environment"));n&&(n.value=a?a.id:e[0].id),s=n&&n.value?n.value:e[0].id}else n&&n.classList.add("hidden");o&&o.isScanning&&await o.stop(),o=new Html5QrcodeScanner("reader",{fps:10,qrbox:250,aspectRatio:1.333333,disableFlip:!1,videoConstraints:{deviceId:{exact:s}}},!1),await o.render(X,Z),c.textContent="Siap memindai QR Code..."}else r("Tidak ada kamera yang ditemukan.","error"),c.textContent="Tidak ada kamera yang ditemukan.",h.innerHTML='<p class="text-red-500 mt-8">Gagal mengakses kamera. Pastikan browser memiliki izin dan kamera terhubung.</p>',n&&n.classList.add("hidden")}catch(e){console.error("Error accessing camera:",e),r(`Gagal mengakses kamera: ${e.message}`,"error"),c.textContent="Gagal mengakses kamera.",h.innerHTML='<p class="text-red-500 mt-8">Gagal mengakses kamera. Pastikan browser memiliki izin dan kamera terhubung.</p>',n&&n.classList.add("hidden")}};n&&n.addEventListener("change",async()=>{o&&o.isScanning&&await o.stop(),k()});const ee=()=>{C.reset(),d.classList.add("hidden"),y.classList.add("hidden"),d.textContent="",y.textContent=""};if(M&&M.addEventListener("click",e=>{e.preventDefault(),ee(),g.classList.remove("hidden"),setTimeout(()=>g.classList.add("active"),10),L&&L.classList.remove("active")}),D&&D.addEventListener("click",()=>{g.classList.remove("active"),setTimeout(()=>g.classList.add("hidden"),300)}),A&&A.addEventListener("click",()=>{g.classList.remove("active"),setTimeout(()=>g.classList.add("hidden"),300)}),C&&C.addEventListener("submit",async e=>{e.preventDefault(),d.classList.add("hidden"),y.classList.add("hidden"),d.textContent="",y.textContent="";const s=j.value,a=Y.value,t=J.value;if(a!==t){d.textContent="Password baru dan konfirmasi password tidak cocok.",d.classList.remove("hidden");return}if(a.length<6){d.textContent="Password baru minimal 6 karakter.",d.classList.remove("hidden");return}const i=m.getCurrentUser();if(!i||!i.id||!localStorage.getItem("token")){r("Sesi tidak valid. Harap login kembali.","error"),setTimeout(()=>m.logout(),2e3);return}try{const w=await m.changePassword(s,a);y.textContent=w.message||"Password berhasil diubah!",y.classList.remove("hidden"),r("Password berhasil diubah!","success"),setTimeout(()=>{g.classList.remove("active"),setTimeout(()=>g.classList.add("hidden"),300)},1500)}catch(w){console.error("Error changing password:",w);const $=w.message||"Gagal mengubah password. Silakan coba lagi.";d.textContent=$,d.classList.remove("hidden"),r($,"error")}}),v&&(v.addEventListener("click",()=>{L.classList.toggle("active")}),document.addEventListener("click",e=>{v.contains(e.target)||L.classList.remove("active")})),K.forEach(e=>{e.addEventListener("click",s=>{s.preventDefault(),te()})}),P&&f&&E&&T){const e=()=>{f.classList.remove("hidden"),setTimeout(()=>{f.classList.add("opacity-100"),E.classList.remove("-translate-x-full")},10)},s=()=>{f.classList.remove("opacity-100"),E.classList.add("-translate-x-full"),setTimeout(()=>f.classList.add("hidden"),300)};P.addEventListener("click",e),T.addEventListener("click",s),f.addEventListener("click",a=>{a.target===f&&s()})}const te=()=>{const e=document.createElement("div");e.className="flex flex-col items-center p-2",e.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
            <div class="flex space-x-3">
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const s=q({node:e,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();e.querySelector("#confirmLogoutBtn").addEventListener("click",()=>{m.logout(),s.hideToast()}),e.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{s.hideToast()})};await V()&&G()});
