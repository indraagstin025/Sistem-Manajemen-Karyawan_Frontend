import"../input-214ac174.js";import{L as O}from"../LeaveRequestsServices-d7327dcf.js";import{a as E}from"../AuthServices-0f733033.js";import{i as Y}from"../sidebarHandler-d6522c99.js";import{g as Q}from"../photoUtils-c92e179b.js";import{T as D}from"../toastify-85d374dd.js";import"../UserServices-9109671c.js";const X="https://sistem-manajemen-karyawanbackend-production.up.railway.app",z=s=>s?s.startsWith("http://")||s.startsWith("https://")?s:`${X}${s}`:null,p=(s,L="success")=>{let k;L==="success"?k="linear-gradient(to right, #22c55e, #16a34a)":L==="error"?k="linear-gradient(to right, #ef4444, #dc2626)":k="linear-gradient(to right, #3b82f6, #2563eb)",D({text:s,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:k,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},Z=()=>{const s=document.createElement("div");s.className="flex flex-col items-center p-2",s.innerHTML=`
        <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
        <div class="flex space-x-3">
            <button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
            <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
        </div>
    `;const L=D({node:s,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();s.querySelector("#confirmActionBtn").addEventListener("click",()=>{E.logout(),L.hideToast()}),s.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{L.hideToast()})};document.addEventListener("DOMContentLoaded",async()=>{Y();const s=document.getElementById("leaveRequestsTableBody"),L=document.getElementById("leaveRequestsMessage"),k=document.getElementById("userAvatar"),I=document.getElementById("userNameNav");document.getElementById("dropdownMenu");const J=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),A=document.getElementById("paginationControls"),M=document.getElementById("prevPageBtn"),$=document.getElementById("nextPageBtn"),V=document.getElementById("currentPageInfo"),u=document.getElementById("attachmentViewerModal"),N=document.getElementById("closeAttachmentViewerModalBtn"),w=document.getElementById("attachmentContent"),h=document.getElementById("attachmentErrorMessage"),H=document.getElementById("attachmentModalTitle");let f=1;const x=10;let v=[];const q=async()=>{try{if(!localStorage.getItem("token"))return null;let t=E.getCurrentUser();if(!t||t.role!=="admin")return null;const r=z(t.photo)||"https://placehold.co/40x40/E2E8F0/4A5568?text=AD";k&&(k.src=r,k.alt=t.name||"Admin"),I&&(I.textContent=t.name||"Admin")}catch(a){console.error("Error fetching admin profile data for header:",a)}},P=async()=>{s.innerHTML=`
                <tr>
                    <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat pengajuan...</td>
                </tr>
            `,L.classList.add("hidden"),A.classList.add("hidden");try{if(!localStorage.getItem("token")){p("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>E.logout(),2e3);return}const t=E.getCurrentUser();if(!t||t.role!=="admin"){p("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>E.logout(),2e3);return}v=await O.getAllLeaveRequests()||[],v.sort((o,d)=>o.status==="pending"&&d.status!=="pending"?-1:o.status!=="pending"&&d.status==="pending"?1:new Date(d.createdAt)-new Date(o.createdAt)),v.length===0?(s.innerHTML=`
                                <tr>
                                    <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada pengajuan cuti/izin yang ditemukan.</td>
                                </tr>
                            `,L.textContent="Tidak ada pengajuan cuti atau izin yang perlu ditinjau.",L.classList.remove("hidden")):(S(v,f,x),j(v.length,f,x))}catch(a){console.error("Error loading leave requests:",a),s.innerHTML=`
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat pengajuan: ${a.message}</td>
                        </tr>
                    `,p(a.message||"Gagal memuat pengajuan cuti/izin.","error"),(a.message.includes("token")||a.message.includes("sesi")||a.message.includes("Akses ditolak"))&&setTimeout(()=>E.logout(),2e3)}},_=async a=>{const t=a.currentTarget,r=t.dataset.url;let o=t.dataset.filename;if(u.classList.remove("active"),u.classList.add("hidden"),w.innerHTML="",h.classList.add("hidden"),H.textContent=`Lihat Lampiran: ${o||"Memuat..."}`,!r){h.textContent="URL lampiran tidak ditemukan.",h.classList.remove("hidden"),p("URL lampiran tidak ditemukan.","error");return}const d=localStorage.getItem("token");if(!d){h.textContent="Sesi tidak valid. Harap login ulang.",h.classList.remove("hidden"),p("Sesi tidak valid. Harap login ulang.","error");return}u.classList.remove("hidden"),setTimeout(()=>u.classList.add("active"),10);try{const i=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${d}`}});if(!i.ok){const n=await i.text();let c=`Gagal memuat lampiran: ${i.status}`;try{c=JSON.parse(n).message||c}catch{c=`${c} - ${n.substring(0,100)}...`}throw new Error(c)}const e=await i.blob(),g=URL.createObjectURL(e),l=i.headers.get("Content-Disposition");if(l&&l.includes("filename=")){const n=l.match(/filename="?(.+)"?/);n&&n[1]&&(o=n[1].replace(/['"]/g,""))}H.textContent=`Lihat Lampiran: ${o||"Tidak Diketahui"}`;const b=i.headers.get("Content-Type")||e.type;if(b.startsWith("image/")){const n=document.createElement("img");n.src=g,n.alt=o,n.className="max-w-full max-h-full object-contain",w.appendChild(n)}else if(b==="application/pdf"){const n=document.createElement("iframe");n.src=g,n.style.width="100%",n.style.height="100%",n.style.border="none",n.setAttribute("allowfullscreen",""),n.setAttribute("webkitallowfullscreen",""),n.setAttribute("mozallowfullscreen",""),w.appendChild(n)}else{h.textContent=`Tipe file '${b||"tidak diketahui"}' tidak didukung untuk tampilan langsung. Silakan unduh.`,h.classList.remove("hidden");const n=document.createElement("button");n.textContent="Unduh File",n.className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",n.addEventListener("click",()=>C({target:{dataset:{url:r,filename:o}}})),w.appendChild(n)}u.addEventListener("transitionend",function n(){u.classList.contains("hidden")&&(URL.revokeObjectURL(g),u.removeEventListener("transitionend",n))},{once:!0})}catch(i){console.error("Gagal memuat lampiran untuk tampilan:",i),h.textContent=i.message||"Terjadi kesalahan saat memuat lampiran.",h.classList.remove("hidden"),p(i.message||"Gagal memuat lampiran.","error"),u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)}},C=async a=>{const t=a.target,r=t.dataset.url,o=t.dataset.filename;if(!r){p("URL lampiran tidak ditemukan.","error");return}const d=localStorage.getItem("token");if(!d){p("Sesi tidak valid. Silakan login ulang.","error");return}const i=t.textContent;t.disabled=!0,t.textContent="Mengunduh...";try{const e=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${d}`}});if(!e.ok){const m=await e.text();let y=`Gagal mengunduh file: ${e.status}`;try{y=JSON.parse(m).message||y}catch{y=`${y} - ${m.substring(0,100)}...`}throw new Error(y)}const g=e.headers.get("Content-Disposition");let l="file";if(g&&g.includes("filename=")){const m=g.match(/filename="?(.+)"?/);m&&m[1]&&(l=m[1].replace(/['"]/g,""))}else if(o)l=o;else{const m=r.split("/");l=m[m.length-1].split("?")[0]}const b=await e.blob(),n=URL.createObjectURL(b),c=document.createElement("a");c.href=n,c.download=l,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(n),p("File berhasil diunduh!","success")}catch(e){console.error("Gagal mengunduh file:",e),p(e.message||"Terjadi kesalahan saat mengunduh file.","error")}finally{t.disabled=!1,t.textContent=i}},S=(a,t,r)=>{const o=document.getElementById("leaveRequestsTableBody");if(!o)return;o.innerHTML="";const d=(t-1)*r,i=a.slice(d,d+r);if(i.length===0){o.innerHTML='<tr><td colspan="9" class="text-center py-10 text-gray-500">Tidak ada data pengajuan.</td></tr>';return}i.forEach(e=>{const g=o.insertRow(),l=new Date(e.start_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),b=new Date(e.end_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});let n="pending",c="Menunggu";e.status==="approved"?(n="approved",c="Disetujui"):e.status==="rejected"?(n="rejected",c="Ditolak"):e.status==="completed"&&(n="completed",c="Selesai");const m=z(e.attachment_url),y=e.attachment_url?e.attachment_url.split("/").pop().split("?")[0]:"",R=m?`<div class="flex items-center space-x-2">
                        <button class="view-attachment-btn text-teal-600 hover:underline focus:outline-none" data-url="${m}" data-filename="${y}">Lihat</button>
                        <button class="download-btn text-gray-500 hover:text-gray-700" data-url="${m}" data-filename="${y}" title="Unduh Lampiran">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                        </button>
                    </div>`:"-",B=e.user_name||e.user_email||e.user_id,K=`https://placehold.co/36x36/E2E8F0/4A5568?text=${B?B.charAt(0).toUpperCase():"?"}`,G=`photo-${e.id}`;g.innerHTML=`
                <td>
                    <div class="employee-info">
                        <img id="${G}" class="profile-thumb" src="${K}" alt="${B}">
                        <div>
                            <div class="name">${B}</div>
                            <div class="email">${e.user_email||"-"}</div>
                        </div>
                    </div>
                </td>
                <td>${e.request_type||"-"}</td>
                <td>${l}</td>
                <td>${b}</td>
                <td title="${e.reason||""}">${e.reason||"-"}</td>
                <td class="text-center">${R}</td>
                <td class="text-center">
                    <span class="status-badge ${n}">${c}</span>
                </td>
                <td title="${e.note||""}">${e.note||"-"}</td>
                <td>
                    ${e.status==="pending"?`
                            <div class="action-buttons">
                                <button data-id="${e.id}" data-action="approve" class="action-btn bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md transition-colors duration-200">Setujui</button>
                                <button data-id="${e.id}" data-action="reject" class="action-btn bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition-colors duration-200">Tolak</button>
                            </div>
                            `:'<span class="text-gray-500 text-sm">Selesai</span>'}
                </td>
            `,Q(e.user_id,B,36).then(W=>{const F=document.getElementById(G);F&&(F.src=W)})}),o.querySelectorAll(".view-attachment-btn").forEach(e=>{e.removeEventListener("click",_),e.addEventListener("click",_)}),o.querySelectorAll(".download-btn").forEach(e=>{e.removeEventListener("click",C),e.addEventListener("click",C)}),o.querySelectorAll(".action-btn").forEach(e=>{e.removeEventListener("click",U),e.addEventListener("click",U)})},j=(a,t,r)=>{const o=Math.ceil(a/r);V.textContent=`Halaman ${t} dari ${o}`,M.disabled=t===1;const d=a===0||t===o;$.disabled=d,a>r?A.classList.remove("hidden"):A.classList.add("hidden")},U=async a=>{const t=a.target,r=t.dataset.id,o=t.dataset.action;let d="",i="",e="",g="";if(o==="approve")d="approved",i="Anda yakin ingin MENYETUJUI pengajuan ini?",e="Pengajuan berhasil disetujui.";else if(o==="reject"){if(d="rejected",i="Anda yakin ingin MENOLAK pengajuan ini?",e="Pengajuan berhasil ditolak.",g=prompt("Masukkan catatan penolakan (opsional):"),g===null)return}else return;const l=document.createElement("div");l.className="flex flex-col items-center p-2",l.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">${i}</p>
            <div class="flex space-x-3">
                <button id="confirmActionBtn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">Ya</button>
                <button id="cancelActionBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const b=D({node:l,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();l.querySelector("#confirmActionBtn").addEventListener("click",async()=>{b.hideToast();try{t.disabled=!0,t.textContent="Memproses...",await O.updateLeaveRequestStatus(r,d,g),p(e,"success"),P()}catch(n){console.error("Error updating leave request status:",n),p(n.message||"Gagal memperbarui status pengajuan.","error"),t.disabled=!1,t.textContent=o==="approve"?"Setujui":"Tolak"}}),l.querySelector("#cancelActionBtn").addEventListener("click",()=>{b.hideToast()})};M&&M.addEventListener("click",()=>{f>1&&(f--,S(v,f,x),j(v.length,f,x))}),$&&$.addEventListener("click",()=>{const a=Math.ceil(v.length/x);f<a&&(f++,S(v,f,x),j(v.length,f,x))}),s&&s.addEventListener("click",a=>{a.target.classList.contains("action-btn")&&U(a)});const T=document.querySelector(".header .relative.group");T&&(T.addEventListener("click",a=>{const t=T.querySelector("#dropdownMenu");a.target.closest("#dropdownMenu a")||t&&(t.classList.toggle("hidden"),t.classList.toggle("active"))}),document.addEventListener("click",a=>{const t=T.querySelector("#dropdownMenu");t&&!T.contains(a.target)&&!t.contains(a.target)&&(t.classList.remove("active"),setTimeout(()=>{t.classList.add("hidden")},200))},!0)),J.forEach(a=>{a.addEventListener("click",t=>{t.preventDefault(),Z()})}),N&&(N.addEventListener("click",()=>{u.classList.remove("active"),setTimeout(()=>{u.classList.add("hidden"),w.innerHTML="",h.classList.add("hidden")},300)}),u.addEventListener("click",a=>{a.target===u&&(u.classList.remove("active"),setTimeout(()=>{u.classList.add("hidden"),w.innerHTML="",h.classList.add("hidden")},300))})),q(),P()});
