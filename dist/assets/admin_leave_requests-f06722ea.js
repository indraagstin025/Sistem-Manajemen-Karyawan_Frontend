import"./input-d134dd88.js";import{L as z}from"./LeaveRequestsServices-ddeca199.js";import{a as B}from"./AuthServices-f47c4eb9.js";import{i as et}from"./sidebarHandler-d6522c99.js";import{i as at,S as O}from"./logoutHandler-87b1a96c.js";import{Q as j}from"./qrCodeHandler-01879f51.js";import{g as F}from"./photoUtils-240b8068.js";import{T as nt}from"./toastify-3acd0462.js";/* empty css                 */import"./AttendanceServices-f61bdc29.js";const ot="https://sistem-manajemen-karyawanbackend-production.up.railway.app",st=d=>d?d.startsWith("http://")||d.startsWith("https://")?d:`${ot}${d}`:null,c=(d,w="success")=>{let k;w==="success"?k="linear-gradient(to right, #22c55e, #16a34a)":w==="error"?k="linear-gradient(to right, #ef4444, #dc2626)":k="linear-gradient(to right, #3b82f6, #2563eb)",nt({text:d,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:k,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},it=()=>{O.fire({title:"Anda yakin ingin keluar?",text:"Anda akan diarahkan ke halaman login.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, Keluar",cancelButtonText:"Batal"}).then(d=>{d.isConfirmed&&B.logout()})};document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),et(),j.initialize({toastCallback:c}),at({preLogoutCallback:()=>{typeof j<"u"&&j.close&&j.close()}});const d=document.getElementById("leaveRequestsTableBody"),w=document.getElementById("leaveRequestsMessage"),k=document.getElementById("userAvatar"),D=document.getElementById("userNameNav"),y=document.getElementById("dropdownMenu"),V=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),M=document.getElementById("paginationControls"),$=document.getElementById("prevPageBtn"),A=document.getElementById("nextPageBtn"),J=document.getElementById("currentPageInfo"),u=document.getElementById("attachmentViewerModal"),U=document.getElementById("closeAttachmentViewerModalBtn"),T=document.getElementById("attachmentContent"),h=document.getElementById("attachmentErrorMessage"),C=document.getElementById("attachmentModalTitle");let L=1;const x=10;let b=[];const q=async()=>{try{if(!localStorage.getItem("token"))return;let t=B.getCurrentUser();if(!t||t.role!=="admin")return;const i=await F(t.id,t.name,40);k&&(k.src=i,k.alt=t.name||"Admin"),D&&(D.textContent=t.name||"Admin")}catch(e){console.error("Error fetching admin profile data for header:",e)}},P=async()=>{d.innerHTML=`
            <tr>
                <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat pengajuan...</td>
            </tr>
            `,w.classList.add("hidden"),M.classList.add("hidden");try{if(!localStorage.getItem("token")){c("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>B.logout(),2e3);return}const t=B.getCurrentUser();if(!t||t.role!=="admin"){c("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>B.logout(),2e3);return}const i=await z.getAllLeaveRequests();console.log("Data mentah dari API:",i),b=i||[],b.sort((s,o)=>s.status==="pending"&&o.status!=="pending"?-1:s.status!=="pending"&&o.status==="pending"?1:new Date(o.createdAt)-new Date(s.createdAt)),b.length===0?(d.innerHTML=`
                                <tr>
                                    <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada pengajuan cuti/izin yang ditemukan.</td>
                                </tr>
                            `,w.textContent="Tidak ada pengajuan cuti atau izin yang perlu ditinjau.",w.classList.remove("hidden")):(I(b,L,x),R(b.length,L,x))}catch(e){console.error("Error loading leave requests:",e),d.innerHTML=`
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat pengajuan: ${e.message}</td>
                        </tr>
                    `,c(e.message||"Gagal memuat pengajuan cuti/izin.","error"),(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Akses ditolak"))&&setTimeout(()=>B.logout(),2e3)}},K=async e=>{const t=e.target.closest(".view-attachment-btn");if(!t)return;const i=t.dataset.url;if(T.innerHTML="",h.classList.add("hidden"),C.textContent="Lihat Lampiran: Memuat...",u.classList.remove("hidden"),setTimeout(()=>u.classList.add("active"),10),!i){C.textContent="Lihat Lampiran: Gagal",h.textContent="URL lampiran tidak ditemukan.",h.classList.remove("hidden"),c("URL lampiran tidak ditemukan.","error");return}const s=localStorage.getItem("token");if(!s){C.textContent="Lihat Lampiran: Gagal",h.textContent="Sesi tidak valid. Harap login ulang.",h.classList.remove("hidden"),c("Sesi tidak valid. Harap login ulang.","error");return}try{const o=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(!o.ok){const a=await o.text();let r=`Gagal memuat lampiran: ${o.status}`;try{r=JSON.parse(a).message||r}catch{r=`${r} - ${a.substring(0,100)}...`}throw new Error(r)}let m="File Lampiran";const n=o.headers.get("Content-Disposition");if(n&&n.includes("filename=")){const a=n.match(/filename="?(.+)"?/);a&&a[1]&&(m=a[1].replace(/['"]/g,""))}C.textContent=`Lihat Lampiran: ${m}`;const g=await o.blob(),l=URL.createObjectURL(g),f=o.headers.get("Content-Type")||g.type;if(f.startsWith("image/")){const a=document.createElement("img");a.src=l,a.alt=m,a.className="max-w-full max-h-full object-contain",T.appendChild(a)}else if(f==="application/pdf"){const a=document.createElement("iframe");a.src=l,a.style.width="100%",a.style.height="100%",a.style.border="none",a.setAttribute("allowfullscreen",""),T.appendChild(a)}else{h.textContent=`Tipe file '${f||"tidak diketahui"}' tidak didukung untuk tampilan langsung. Silakan unduh.`,h.classList.remove("hidden");const a=document.createElement("button");a.textContent="Unduh File",a.className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",a.addEventListener("click",()=>H({target:{dataset:{url:i,filename:m}}})),T.appendChild(a)}u.addEventListener("transitionend",function a(){u.classList.contains("hidden")&&(URL.revokeObjectURL(l),u.removeEventListener("transitionend",a))},{once:!0})}catch(o){C.textContent="Lihat Lampiran: Gagal",console.error("Gagal memuat lampiran untuk tampilan:",o),h.textContent=o.message||"Terjadi kesalahan saat memuat lampiran.",h.classList.remove("hidden"),c(o.message||"Gagal memuat lampiran.","error"),u.classList.remove("active"),setTimeout(()=>u.classList.add("hidden"),300)}},H=async e=>{const t=e.target,i=t.dataset.url,s=t.dataset.filename;if(!i){c("URL lampiran tidak ditemukan.","error");return}const o=localStorage.getItem("token");if(!o){c("Sesi tidak valid. Silakan login ulang.","error");return}const m=t.textContent;t.disabled=!0,t.textContent="Mengunduh...";try{const n=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${o}`}});if(!n.ok){const p=await n.text();let v=`Gagal mengunduh file: ${n.status}`;try{v=JSON.parse(p).message||v}catch{v=`${v} - ${p.substring(0,100)}...`}throw new Error(v)}const g=n.headers.get("Content-Disposition");let l="file";if(g&&g.includes("filename=")){const p=g.match(/filename="?(.+)"?/);p&&p[1]&&(l=p[1].replace(/['"]/g,""))}else if(s)l=s;else{const p=i.split("/");l=p[p.length-1].split("?")[0]}const f=await n.blob(),a=URL.createObjectURL(f),r=document.createElement("a");r.href=a,r.download=l,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(a),c("File berhasil diunduh!","success")}catch(n){console.error("Gagal mengunduh file:",n),c(n.message||"Terjadi kesalahan saat mengunduh file.","error")}finally{t.disabled=!1,t.textContent=m}},I=(e,t,i)=>{const s=document.getElementById("leaveRequestsTableBody");if(!s)return;s.innerHTML="";const o=(t-1)*i,m=e.slice(o,o+i);if(m.length===0){s.innerHTML='<tr><td colspan="5" class="text-center py-10 text-gray-500">Tidak ada data pengajuan.</td></tr>';return}m.forEach(n=>{const g=new Date(n.start_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long"}),l=new Date(n.end_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),f=g===l.split(" ")[0]+" "+l.split(" ")[1]?l:`${g} - ${l}`;let a="pending",r="Menunggu";n.status==="approved"?(a="approved",r="Disetujui"):n.status==="rejected"&&(a="rejected",r="Ditolak");const p=`<span class="status-badge ${a}">${r}</span>`,v=st(n.attachment_url),E=n.attachment_url?n.attachment_url.split("/").pop().split("?")[0]:"",Y=v?`<div class="flex items-center space-x-2">
                   <button class="view-attachment-btn text-teal-600 hover:underline focus:outline-none" data-url="${v}" data-filename="${E}">Lihat</button>
                   <button class="download-btn text-gray-500 hover:text-gray-700" data-url="${v}" data-filename="${E}" title="Unduh Lampiran">
                       <i data-feather="download" class="w-4 h-4"></i>
                   </button>
               </div>`:"-",X=n.status==="pending"?`<div class="action-buttons flex space-x-2 justify-end">
                   <button data-id="${n.id}" data-action="approve" class="action-btn px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md transition-colors duration-200">Setujui</button>
                   <button data-id="${n.id}" data-action="reject" class="action-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition-colors duration-200">Tolak</button>
               </div>`:'<span class="text-gray-500 text-xs">Selesai</span>',G=n.user_name||n.user_email||"Pengguna Tidak Dikenal",_=`photo-${n.id}`,Z=`
            <tr class="main-row">
                <td data-label="Karyawan">
                    <div class="employee-info">
                        <img id="${_}" class="h-9 w-9 rounded-full object-cover" src="https://placehold.co/36x36/E2E8F0/4A5568?text=AV" alt="Avatar">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${G}</div>
                            <div class="text-sm text-gray-500 email">${n.user_email||"-"}</div>
                        </div>
                    </div>
                </td>
                <td data-label="Tipe">${n.request_type||"-"}</td>
                <td data-label="Tanggal">${f}</td>
                <td data-label="Status">${p}</td>
                <td data-label="Aksi">
                    <div class="action-buttons-wrapper">
                        ${X}
                        <button class="toggle-details-btn" title="Lihat Detail">
                           <i data-feather="chevron-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
            </tr>
            <tr class="detail-row hidden">
                <td colspan="5">
                    <div class="details-content">
                        <div><strong>Alasan:</strong><p>${n.reason||"-"}</p></div>
                        <div><strong>Lampiran:</strong><p>${Y}</p></div>
                        <div><strong>Catatan Admin:</strong><p>${n.note||"-"}</p></div>
                    </div>
                </td>
            </tr>
        `;s.insertAdjacentHTML("beforeend",Z),F(n.user_id,G,36).then(tt=>{const N=document.getElementById(_);N&&(N.src=tt)})}),feather.replace()};function W(){document.getElementById("leaveRequestsTableBody").addEventListener("click",function(t){const i=t.target.closest(".toggle-details-btn");if(i){const s=i.closest(".main-row"),o=s.nextElementSibling;s&&o&&o.classList.contains("detail-row")&&(o.classList.toggle("hidden"),s.classList.toggle("is-expanded"))}})}W();const R=(e,t,i)=>{const s=Math.ceil(e/i);J.textContent=`Halaman ${t} dari ${s}`,$.disabled=t===1;const o=e===0||t===s;A.disabled=o,e>i?M.classList.remove("hidden"):M.classList.add("hidden")},Q=async e=>{const t=e.target,i=t.dataset.id,s=t.dataset.action;let o="",m="",n="",g="",l="",f="question";if(s==="approve")o="approved",m="Setujui Pengajuan Ini?",n="Anda akan menyetujui pengajuan cuti/izin ini.",g="Catatan persetujuan (wajib)",l="Catatan Persetujuan:",f="success";else if(s==="reject")o="rejected",m="Tolak Pengajuan Ini?",n="Anda akan menolak pengajuan cuti/izin ini.",g="Catatan penolakan (wajib)",l="Catatan Penolakan:",f="error";else return;const{value:a}=await O.fire({title:m,text:n,icon:f,input:"textarea",inputLabel:l,inputPlaceholder:g,inputValidator:r=>{if(!r||r.trim()==="")return"Catatan wajib diisi!"},showCancelButton:!0,confirmButtonText:"Ya, Proses",cancelButtonText:"Batal",confirmButtonColor:s==="approve"?"#10b981":"#dc2626",cancelButtonColor:"#6b7280",reverseButtons:!0});if(a==null||a.trim()===""){c("Proses dibatalkan: Catatan tidak diisi.","info");return}try{t.disabled=!0,t.textContent="Memproses...",await z.updateLeaveRequestStatus(i,o,a),c(`Pengajuan berhasil ${s==="approve"?"disetujui":"ditolak"}.`,"success"),P()}catch(r){console.error("Error updating leave request status:",r),c(r.message||"Gagal memperbarui status pengajuan.","error"),t.disabled=!1,t.textContent=s==="approve"?"Setujui":"Tolak"}};$&&$.addEventListener("click",()=>{L>1&&(L--,I(b,L,x),R(b.length,L,x))}),A&&A.addEventListener("click",()=>{const e=Math.ceil(b.length/x);L<e&&(L++,I(b,L,x),R(b.length,L,x))}),d&&d.addEventListener("click",e=>{const t=e.target;t.classList.contains("action-btn")?Q(e):t.classList.contains("view-attachment-btn")?K(e):t.classList.contains("download-btn")&&H(e)});const S=document.getElementById("userDropdown");S&&y&&(S.addEventListener("click",e=>{!y.contains(e.target)&&e.target.closest("#userAvatar")&&(y.classList.toggle("hidden"),y.classList.toggle("active"))}),document.addEventListener("click",e=>{y&&!S.contains(e.target)&&!y.contains(e.target)&&(y.classList.remove("active"),setTimeout(()=>{y.classList.add("hidden")},200))},!0)),V.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),it()})}),U&&(U.addEventListener("click",()=>{u.classList.remove("active"),setTimeout(()=>{u.classList.add("hidden"),T.innerHTML="",h.classList.add("hidden")},300)}),u.addEventListener("click",e=>{e.target===u&&(u.classList.remove("active"),setTimeout(()=>{u.classList.add("hidden"),T.innerHTML="",h.classList.add("hidden")},300))})),q(),P()});
