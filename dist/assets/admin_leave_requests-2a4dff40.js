import"./input-ac4e21e1.js";import{L as F}from"./LeaveRequestsServices-57462767.js";import{a as E}from"./AuthServices-0f733033.js";import{i as Y}from"./sidebarHandler-d6522c99.js";import{i as X,S as V}from"./logoutHandler-a2e70173.js";import{Q as B}from"./qrCodeHandler-3c60f548.js";import{g as Z}from"./photoUtils-c92e179b.js";import{T as tt}from"./toastify-3acd0462.js";/* empty css                 */import"./AttendanceServices-9bf2f837.js";import"./UserServices-9109671c.js";const et="https://sistem-manajemen-karyawanbackend-production.up.railway.app",O=d=>d?d.startsWith("http://")||d.startsWith("https://")?d:`${et}${d}`:null,g=(d,w="success")=>{let L;w==="success"?L="linear-gradient(to right, #22c55e, #16a34a)":w==="error"?L="linear-gradient(to right, #ef4444, #dc2626)":L="linear-gradient(to right, #3b82f6, #2563eb)",tt({text:d,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:L,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},at=()=>{V.fire({title:"Anda yakin ingin keluar?",text:"Anda akan diarahkan ke halaman login.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, Keluar",cancelButtonText:"Batal"}).then(d=>{d.isConfirmed&&E.logout()})};document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),Y(),B.initialize({toastCallback:g}),X({preLogoutCallback:()=>{typeof B<"u"&&B.close&&B.close()}});const d=document.getElementById("leaveRequestsTableBody"),w=document.getElementById("leaveRequestsMessage"),L=document.getElementById("userAvatar"),R=document.getElementById("userNameNav");document.getElementById("dropdownMenu");const J=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),$=document.getElementById("paginationControls"),j=document.getElementById("prevPageBtn"),A=document.getElementById("nextPageBtn"),q=document.getElementById("currentPageInfo"),c=document.getElementById("attachmentViewerModal"),P=document.getElementById("closeAttachmentViewerModalBtn"),x=document.getElementById("attachmentContent"),h=document.getElementById("attachmentErrorMessage"),H=document.getElementById("attachmentModalTitle");let v=1;const y=10;let k=[];const W=async()=>{try{if(!localStorage.getItem("token"))return null;let e=E.getCurrentUser();if(!e||e.role!=="admin")return null;const r=O(e.photo)||"https://placehold.co/40x40/E2E8F0/4A5568?text=AD";L&&(L.src=r,L.alt=e.name||"Admin"),R&&(R.textContent=e.name||"Admin")}catch(n){console.error("Error fetching admin profile data for header:",n)}},z=async()=>{d.innerHTML=`
            <tr>
                <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat pengajuan...</td>
            </tr>
            `,w.classList.add("hidden"),$.classList.add("hidden");try{if(!localStorage.getItem("token")){g("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>E.logout(),2e3);return}const e=E.getCurrentUser();if(!e||e.role!=="admin"){g("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>E.logout(),2e3);return}k=await F.getAllLeaveRequests()||[],k.sort((o,l)=>o.status==="pending"&&l.status!=="pending"?-1:o.status!=="pending"&&l.status==="pending"?1:new Date(l.createdAt)-new Date(o.createdAt)),k.length===0?(d.innerHTML=`
                                <tr>
                                    <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada pengajuan cuti/izin yang ditemukan.</td>
                                </tr>
                            `,w.textContent="Tidak ada pengajuan cuti atau izin yang perlu ditinjau.",w.classList.remove("hidden")):(S(k,v,y),I(k.length,v,y))}catch(n){console.error("Error loading leave requests:",n),d.innerHTML=`
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat pengajuan: ${n.message}</td>
                        </tr>
                    `,g(n.message||"Gagal memuat pengajuan cuti/izin.","error"),(n.message.includes("token")||n.message.includes("sesi")||n.message.includes("Akses ditolak"))&&setTimeout(()=>E.logout(),2e3)}},N=async n=>{const e=n.currentTarget,r=e.dataset.url;let o=e.dataset.filename;if(c.classList.remove("active"),c.classList.add("hidden"),x.innerHTML="",h.classList.add("hidden"),H.textContent=`Lihat Lampiran: ${o||"Memuat..."}`,!r){h.textContent="URL lampiran tidak ditemukan.",h.classList.remove("hidden"),g("URL lampiran tidak ditemukan.","error");return}const l=localStorage.getItem("token");if(!l){h.textContent="Sesi tidak valid. Harap login ulang.",h.classList.remove("hidden"),g("Sesi tidak valid. Harap login ulang.","error");return}c.classList.remove("hidden"),setTimeout(()=>c.classList.add("active"),10);try{const s=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${l}`}});if(!s.ok){const a=await s.text();let i=`Gagal memuat lampiran: ${s.status}`;try{i=JSON.parse(a).message||i}catch{i=`${i} - ${a.substring(0,100)}...`}throw new Error(i)}const t=await s.blob(),p=URL.createObjectURL(t),m=s.headers.get("Content-Disposition");if(m&&m.includes("filename=")){const a=m.match(/filename="?(.+)"?/);a&&a[1]&&(o=a[1].replace(/['"]/g,""))}H.textContent=`Lihat Lampiran: ${o||"Tidak Diketahui"}`;const f=s.headers.get("Content-Type")||t.type;if(f.startsWith("image/")){const a=document.createElement("img");a.src=p,a.alt=o,a.className="max-w-full max-h-full object-contain",x.appendChild(a)}else if(f==="application/pdf"){const a=document.createElement("iframe");a.src=p,a.style.width="100%",a.style.height="100%",a.style.border="none",a.setAttribute("allowfullscreen",""),a.setAttribute("webkitallowfullscreen",""),a.setAttribute("mozallowfullscreen",""),x.appendChild(a)}else{h.textContent=`Tipe file '${f||"tidak diketahui"}' tidak didukung untuk tampilan langsung. Silakan unduh.`,h.classList.remove("hidden");const a=document.createElement("button");a.textContent="Unduh File",a.className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",a.addEventListener("click",()=>M({target:{dataset:{url:r,filename:o}}})),x.appendChild(a)}c.addEventListener("transitionend",function a(){c.classList.contains("hidden")&&(URL.revokeObjectURL(p),c.removeEventListener("transitionend",a))},{once:!0})}catch(s){console.error("Gagal memuat lampiran untuk tampilan:",s),h.textContent=s.message||"Terjadi kesalahan saat memuat lampiran.",h.classList.remove("hidden"),g(s.message||"Gagal memuat lampiran.","error"),c.classList.remove("active"),setTimeout(()=>c.classList.add("hidden"),300)}},M=async n=>{const e=n.target,r=e.dataset.url,o=e.dataset.filename;if(!r){g("URL lampiran tidak ditemukan.","error");return}const l=localStorage.getItem("token");if(!l){g("Sesi tidak valid. Silakan login ulang.","error");return}const s=e.textContent;e.disabled=!0,e.textContent="Mengunduh...";try{const t=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${l}`}});if(!t.ok){const u=await t.text();let b=`Gagal mengunduh file: ${t.status}`;try{b=JSON.parse(u).message||b}catch{b=`${b} - ${u.substring(0,100)}...`}throw new Error(b)}const p=t.headers.get("Content-Disposition");let m="file";if(p&&p.includes("filename=")){const u=p.match(/filename="?(.+)"?/);u&&u[1]&&(m=u[1].replace(/['"]/g,""))}else if(o)m=o;else{const u=r.split("/");m=u[u.length-1].split("?")[0]}const f=await t.blob(),a=URL.createObjectURL(f),i=document.createElement("a");i.href=a,i.download=m,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(a),g("File berhasil diunduh!","success")}catch(t){console.error("Gagal mengunduh file:",t),g(t.message||"Terjadi kesalahan saat mengunduh file.","error")}finally{e.disabled=!1,e.textContent=s}},S=(n,e,r)=>{const o=document.getElementById("leaveRequestsTableBody");if(!o)return;o.innerHTML="";const l=(e-1)*r,s=n.slice(l,l+r);if(s.length===0){o.innerHTML='<tr><td colspan="9" class="text-center py-10 text-gray-500">Tidak ada data pengajuan.</td></tr>';return}s.forEach(t=>{const p=o.insertRow(),m=new Date(t.start_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),f=new Date(t.end_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});let a="pending",i="Menunggu";t.status==="approved"?(a="approved",i="Disetujui"):t.status==="rejected"?(a="rejected",i="Ditolak"):t.status==="completed"&&(a="completed",i="Selesai");const u=O(t.attachment_url),b=t.attachment_url?t.attachment_url.split("/").pop().split("?")[0]:"",D=u?`<div class="flex items-center space-x-2">
                            <button class="view-attachment-btn text-teal-600 hover:underline focus:outline-none" data-url="${u}" data-filename="${b}">Lihat</button>
                            <button class="download-btn text-gray-500 hover:text-gray-700" data-url="${u}" data-filename="${b}" title="Unduh Lampiran">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                        </div>`:"-",C=t.user_name||t.user_email||t.user_id,K=`https://placehold.co/36x36/E2E8F0/4A5568?text=${C?C.charAt(0).toUpperCase():"?"}`,_=`photo-${t.id}`;p.innerHTML=`
                <td>
                    <div class="employee-info">
                        <img id="${_}" class="profile-thumb" src="${K}" alt="${C}">
                        <div>
                            <div class="name">${C}</div>
                            <div class="email">${t.user_email||"-"}</div>
                        </div>
                    </div>
                </td>
                <td>${t.request_type||"-"}</td>
                <td>${m}</td>
                <td>${f}</td>
                <td title="${t.reason||""}">${t.reason||"-"}</td>
                <td class="text-center">${D}</td>
                <td class="text-center">
                    <span class="status-badge ${a}">${i}</span>
                </td>
                <td title="${t.note||""}">${t.note||"-"}</td>
                <td>
                    ${t.status==="pending"?`
                            <div class="action-buttons">
                                <button data-id="${t.id}" data-action="approve" class="action-btn bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md transition-colors duration-200">Setujui</button>
                                <button data-id="${t.id}" data-action="reject" class="action-btn bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition-colors duration-200">Tolak</button>
                            </div>
                            `:'<span class="text-gray-500 text-sm">Selesai</span>'}
                </td>
            `,Z(t.user_id,C,36).then(Q=>{const G=document.getElementById(_);G&&(G.src=Q)})}),o.querySelectorAll(".view-attachment-btn").forEach(t=>{t.removeEventListener("click",N),t.addEventListener("click",N)}),o.querySelectorAll(".download-btn").forEach(t=>{t.removeEventListener("click",M),t.addEventListener("click",M)}),o.querySelectorAll(".action-btn").forEach(t=>{t.removeEventListener("click",U),t.addEventListener("click",U)})},I=(n,e,r)=>{const o=Math.ceil(n/r);q.textContent=`Halaman ${e} dari ${o}`,j.disabled=e===1;const l=n===0||e===o;A.disabled=l,n>r?$.classList.remove("hidden"):$.classList.add("hidden")},U=async n=>{const e=n.target,r=e.dataset.id,o=e.dataset.action;let l="",s="",t="",p="",m="",f="question";if(o==="approve")l="approved",s="Setujui Pengajuan Ini?",t="Anda akan menyetujui pengajuan cuti/izin ini.",p="Catatan persetujuan (wajib)",m="Catatan Persetujuan:",f="success";else if(o==="reject")l="rejected",s="Tolak Pengajuan Ini?",t="Anda akan menolak pengajuan cuti/izin ini.",p="Catatan penolakan (wajib)",m="Catatan Penolakan:",f="error";else return;const{value:a}=await V.fire({title:s,text:t,icon:f,input:"textarea",inputLabel:m,inputPlaceholder:p,inputValidator:i=>{if(!i||i.trim()==="")return"Catatan wajib diisi!"},showCancelButton:!0,confirmButtonText:"Ya, Proses",cancelButtonText:"Batal",confirmButtonColor:o==="approve"?"#10b981":"#dc2626",cancelButtonColor:"#6b7280",reverseButtons:!0});if(a==null||a.trim()===""){g("Proses dibatalkan: Catatan tidak diisi.","info");return}try{e.disabled=!0,e.textContent="Memproses...",await F.updateLeaveRequestStatus(r,l,a),g(`Pengajuan berhasil ${o==="approve"?"disetujui":"ditolak"}.`,"success"),z()}catch(i){console.error("Error updating leave request status:",i),g(i.message||"Gagal memperbarui status pengajuan.","error"),e.disabled=!1,e.textContent=o==="approve"?"Setujui":"Tolak"}};j&&j.addEventListener("click",()=>{v>1&&(v--,S(k,v,y),I(k.length,v,y))}),A&&A.addEventListener("click",()=>{const n=Math.ceil(k.length/y);v<n&&(v++,S(k,v,y),I(k.length,v,y))}),d&&d.addEventListener("click",n=>{n.target.classList.contains("action-btn")&&U(n)});const T=document.querySelector(".header .relative.group");T&&(T.addEventListener("click",n=>{const e=T.querySelector("#dropdownMenu");n.target.closest("#dropdownMenu a")||e&&(e.classList.toggle("hidden"),e.classList.toggle("active"))}),document.addEventListener("click",n=>{const e=T.querySelector("#dropdownMenu");e&&!T.contains(n.target)&&!e.contains(n.target)&&(e.classList.remove("active"),setTimeout(()=>{e.classList.add("hidden")},200))},!0)),J.forEach(n=>{n.addEventListener("click",e=>{e.preventDefault(),at()})}),P&&(P.addEventListener("click",()=>{c.classList.remove("active"),setTimeout(()=>{c.classList.add("hidden"),x.innerHTML="",h.classList.add("hidden")},300)}),c.addEventListener("click",n=>{n.target===c&&(c.classList.remove("active"),setTimeout(()=>{c.classList.add("hidden"),x.innerHTML="",h.classList.add("hidden")},300))})),W(),z()});
