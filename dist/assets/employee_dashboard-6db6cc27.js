import"./input-15de07a3.js";import{u as M}from"./UserServices-9109671c.js";import{a as p}from"./AuthServices-0f733033.js";import{A as P}from"./AttendanceServices-9bf2f837.js";import{L as H}from"./LeaveRequestsServices-57462767.js";import{T as G}from"./toastify-3acd0462.js";/* empty css                 */import{i as Q,S}from"./logoutHandler-a2e70173.js";import{i as N}from"./sidebarHandler-d6522c99.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),N(),Q();const y=document.getElementById("profilePhoto"),L=document.getElementById("employeeName"),v=document.getElementById("employeePosition"),w=document.getElementById("employeeDepartment"),s=document.getElementById("todayAttendanceStatus"),h=document.getElementById("remainingLeave"),m=document.getElementById("userAvatar"),g=document.getElementById("dropdownMenu"),b=document.getElementById("userDropdown"),c=document.getElementById("scanQrButton"),k=document.getElementById("qrFullscreenContainer"),E=document.getElementById("readerFull"),B=document.getElementById("qrScanResultText"),C=document.getElementById("qr-scan-result"),I=document.getElementById("current-date"),d=document.getElementById("check-in-time"),o=document.getElementById("attendance-status");document.getElementById("attendance-note-display"),document.getElementById("attendance-note");let l=null,f=!1;function u(e,n,t="success",i=!1,r=2e3){S.fire({title:e,text:n,icon:t,showConfirmButton:i,timer:r,timerProgressBar:!0,didOpen:a=>{a.addEventListener("mouseenter",S.stopTimer),a.addEventListener("mouseleave",S.resumeTimer)}})}function F(e,n="success"){let t;n==="success"?t="linear-gradient(to right, #22c55e, #16a34a)":n==="error"?t="linear-gradient(to right, #ef4444, #dc2626)":t="linear-gradient(to right, #3b82f6, #2563eb)",G({text:e,duration:3e3,close:!0,gravity:"top",position:"center",stopOnFocus:!0,style:{background:t,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()}function O(e){return e||"-"}function A(e){const n=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});if(I&&(I.textContent=n),o&&(o.className=""),s&&(s.className="text-lg font-bold"),e){const t=e.status;s&&(s.textContent=t),t==="Hadir"?(s&&s.classList.add("text-green-600"),o&&o.classList.add("text-green-600","font-semibold")):t==="Terlambat"?(s&&s.classList.add("text-orange-500"),o&&o.classList.add("text-orange-500","font-semibold")):["Sakit","Cuti"].includes(t)?(s&&s.classList.add("text-blue-600"),o&&o.classList.add("text-blue-600","font-semibold"),d&&(d.textContent="-")):(s&&s.classList.add("text-red-600"),o&&o.classList.add("text-red-600","font-semibold"),d&&(d.textContent="-")),e.check_in&&d&&(d.textContent=O(e.check_in)),o&&(o.textContent=t)}else s&&(s.textContent="Belum Absen",s.classList.add("text-red-600")),d&&(d.textContent="-"),o&&(o.textContent="Belum Absen",o.classList.add("text-red-600","font-semibold"))}async function U(e){var t,i,r;console.log(`INFO: QR Code terdeteksi, data: ${e}. Memulai proses absensi.`);const n=p.getCurrentUser();if(!n||!n.id){u("Error Autentikasi","Sesi pengguna tidak valid. Silakan login kembali.","error"),f=!1;return}try{const a=await P.scanQR(e,n.id);S.fire({title:"Absensi Berhasil!",text:a.message,icon:"success",confirmButtonText:"Selesai"}),R()}catch(a){console.error("ERROR: Gagal saat memproses absensi di server:",a);const x=((i=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:i.error)||a.message||"Terjadi kesalahan saat menghubungi server.",D=((r=a.response)==null?void 0:r.status)===409?"info":"error";u(D==="info"?"Info Absensi":"Absensi Gagal!",x,D)}finally{f=!1}}async function R(){try{const e=await P.getMyHistory(),n=new Date().toISOString().slice(0,10),t=e.find(r=>r.date===n);A(t);const i=t&&["Hadir","Terlambat","Sakit","Cuti"].includes(t.status);c&&(i?(c.disabled=!0,c.classList.add("bg-gray-400","cursor-not-allowed"),c.classList.remove("bg-indigo-600","hover:bg-indigo-700"),c.innerText="Anda Sudah Absen Hari Ini"):(c.disabled=!1,c.classList.remove("bg-gray-400","cursor-not-allowed"),c.classList.add("bg-indigo-600","hover:bg-indigo-700"),c.innerText="Scan QR Code Absensi"))}catch(e){console.error("ERROR: Gagal memuat riwayat absensi:",e),A(null),c&&(c.disabled=!1)}}const q=async()=>{try{if(!localStorage.getItem("token"))return u("Sesi Tidak Valid","Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>p.logout(),2e3),null;let n;try{if(n=p.getCurrentUser(),!n)throw new Error("Data pengguna tidak ditemukan di sesi.")}catch(r){throw console.error("Error parsing user from localStorage:",r),new Error("Data pengguna di sesi rusak.")}if(n.role!=="karyawan")return u("Akses Ditolak","Akses ditolak. Peran tidak sesuai untuk halaman ini.","error"),setTimeout(()=>p.logout(),2e3),null;const t=await M.getUserByID(n.id),i=await H.getLeaveSummary();if(t){try{const r=await M.getProfilePhoto(n.id),a=URL.createObjectURL(r);y&&(y.src=a),m&&(m.src=a,m.alt=t.name)}catch(r){console.error("Error fetching profile photo:",r);const a="https://via.placeholder.com/96x96/E2E8F0/4A5568?text=ME";y&&(y.src=a),m&&(m.src=a,m.alt=t.name)}if(L&&(L.textContent=t.name),v&&(v.textContent=t.position||"-"),w&&(w.textContent=t.department||"-"),h){const a=i.annual_leave_count||0,x=Math.max(0,12-a);h.textContent=`${x} Kali`,x<=3?h.classList.add("text-red-600","font-semibold"):h.classList.remove("text-red-600","font-semibold")}}return t}catch(e){return console.error("Error fetching employee profile data:",e),u("Gagal Memuat Profil",e.message||"Gagal memuat data profil.","error"),(e.status===401||e.message&&(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Peran tidak sesuai")||e.message.includes("Data pengguna di sesi rusak")))&&setTimeout(()=>p.logout(),2e3),null}};window.openFullscreenScanner=async function(){const e=document.getElementById("closeScannerBtn");if(!k||!E||!e)return console.error("ERROR: Elemen HTML untuk scanner fullscreen tidak ditemukan.");f=!1,k.classList.remove("hidden"),E.innerHTML="",B.textContent="Memulai kamera...",l=new Html5Qrcode(E.id);try{const n=await Html5Qrcode.getCameras();if(!n||n.length===0)throw new Error("Kamera tidak ditemukan di perangkat ini.");const t=n.find(i=>/back|rear|environment/i.test(i.label))||n[n.length-1];console.log("INFO: Menggunakan kamera:",t.label),await l.start(t.id,{fps:10,qrbox:{width:250,height:250},aspectRatio:1},async(i,r)=>{f||(f=!0,l!=null&&l.isScanning&&await l.stop(),k.classList.add("hidden"),F("QR Code terbaca, memproses...","info"),U(i))},i=>{}),B.textContent="Arahkan kamera ke QR Code Absensi"}catch(n){console.error("ERROR: Gagal memulai scanner:",n),u("Gagal Membuka Kamera",n.message,"error"),k.classList.add("hidden")}},b&&(b.addEventListener("click",e=>{e.stopPropagation(),g&&g.classList.toggle("active")}),document.addEventListener("click",e=>{g&&b&&!b.contains(e.target)&&!g.contains(e.target)&&g.classList.remove("active")}));const T=document.getElementById("closeScannerBtn");T&&T.addEventListener("click",async()=>{const e=document.getElementById("qrFullscreenContainer");if(l)try{await l.stop(),console.log("Scanner fullscreen dihentikan via tombol tutup.")}catch(t){console.warn("Gagal menghentikan scanner fullscreen via tombol tutup:",t)}e&&e.classList.add("hidden");const n=document.getElementById("readerFull");n&&(n.innerHTML=""),C&&(C.textContent=""),l=null}),await q()&&R()});
