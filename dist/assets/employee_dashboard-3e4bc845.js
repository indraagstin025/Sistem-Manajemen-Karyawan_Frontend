import"./input-2b7f90d6.js";import{u as K}from"./UserServices-9109671c.js";import{a as m}from"./AuthServices-0f733033.js";import{A as Y}from"./AttendanceServices-812a17ce.js";import{T as J}from"./toastify-85d374dd.js";import{S as H}from"./sweetalert2.esm.all-9d2ad45a.js";document.addEventListener("DOMContentLoaded",async()=>{feather.replace();const D=document.getElementById("profilePhoto"),V=document.getElementById("employeeName"),W=document.getElementById("employeePosition"),X=document.getElementById("employeeDepartment"),g=document.getElementById("todayAttendanceStatus"),U=document.getElementById("remainingLeave"),x=document.getElementById("userAvatar"),E=document.getElementById("dropdownMenu"),B=document.getElementById("userDropdown"),Z=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),$=document.getElementById("sidebarToggle"),b=document.getElementById("mobileSidebar"),I=document.getElementById("mobileSidebarPanel"),G=document.getElementById("closeSidebar"),h=document.getElementById("changePasswordModal"),R=document.getElementById("openChangePasswordModalBtn"),N=document.getElementById("closeChangePasswordModalBtn"),Q=document.getElementById("cancelChangePasswordBtn"),T=document.getElementById("changePasswordForm"),ee=document.getElementById("oldPassword"),te=document.getElementById("newPassword"),ae=document.getElementById("confirmNewPassword"),l=document.getElementById("changePasswordErrorMessage"),w=document.getElementById("changePasswordSuccessMessage"),u=document.getElementById("reader"),o=document.getElementById("qr-scan-result");document.getElementById("notification-message");const p=document.getElementById("camera-select");let f=null,S=!1,v=!1,k=!1;const q=document.getElementById("current-date"),C=document.getElementById("check-in-time"),d=document.getElementById("attendance-status"),P=document.getElementById("attendance-note-display"),A=document.getElementById("attendance-note");function _(e,t,a="success",n=!1,c=2e3){H.fire({title:e,text:t,icon:a,showConfirmButton:n,timer:c,timerProgressBar:!0,didOpen:s=>{s.addEventListener("mouseenter",H.stopTimer),s.addEventListener("mouseleave",H.resumeTimer)}})}function r(e,t="success"){let a;t==="success"?a="linear-gradient(to right, #22c55e, #16a34a)":t==="error"?a="linear-gradient(to right, #ef4444, #dc2626)":a="linear-gradient(to right, #3b82f6, #2563eb)",J({text:e,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:a,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()}function ne(e){return e||"-"}function se(e){const t=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});q.textContent=t,d.className="",g.classList.remove("text-gray-900","text-green-600","text-red-600","text-orange-600","text-blue-600");const a=n=>n==="Tidak Absen"?"Belum Absen":n;if(e){const n=a(e.status);g.textContent=n,e.status==="Hadir"?g.classList.add("text-green-600"):e.status==="Telat"?g.classList.add("text-orange-600"):e.status==="Sakit"||e.status==="Cuti"||e.status==="Izin"?g.classList.add("text-blue-600"):e.status==="Tidak Absen"||e.status==="Belum Absen"?g.classList.add("text-red-600"):g.classList.add("text-gray-900"),C.textContent=ne(e.check_in),d.textContent=n,e.status==="Hadir"?d.classList.add("text-green-600","font-semibold"):e.status==="Telat"?d.classList.add("text-orange-600","font-semibold"):e.status==="Sakit"||e.status==="Cuti"||e.status==="Izin"?(C.textContent="-",d.classList.add("text-blue-600","font-semibold")):e.status==="Tidak Absen"||e.status==="Belum Absen"?(C.textContent="-",d.classList.add("text-red-600","font-semibold")):d.classList.add("text-gray-600","font-semibold"),e.note?(P.classList.remove("hidden"),A.textContent=e.note):(P.classList.add("hidden"),A.textContent="")}else g.textContent="Belum Absen",g.classList.add("text-red-600"),C.textContent="-",d.textContent="Belum Absen",d.classList.add("text-red-600","font-semibold"),P.classList.add("hidden"),A.textContent=""}async function y(){if(f&&k){try{await f.stop(),await f.clear(),console.log("Scanner dihentikan dan dibersihkan.")}catch(e){console.warn("Gagal menghentikan/membersihkan scanner:",e)}k=!1}u.innerHTML="",o.textContent="",p.classList.add("hidden"),v=!1,f=null}async function z(e,t){var n,c,s;if(S){console.warn("Scan diabaikan karena sedang memproses scan sebelumnya.");return}S=!0,console.log(`QR Code terdeteksi: ${e}`),o.textContent="Memproses...";const a=m.getCurrentUser();if(!a||!a.id){r("User tidak terautentikasi. Silakan login kembali.","error"),o.textContent="Error: User tidak terautentikasi.",await y(),S=!1;return}try{const i=await Y.scanQR(e,a.id);_("Absensi Berhasil!",i.message,"success"),o.textContent=i.message,await y(),u.innerHTML='<p class="text-gray-500 mt-8">Absensi berhasil!</p>',M()}catch(i){console.error("Error saat memindai QR Code:",i);const L=((c=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:c.error)||i.message||"Terjadi kesalahan saat absen.";((s=i.response)==null?void 0:s.status)===409?(_("Info Absensi",L,"info"),o.textContent=L,await y(),u.innerHTML=`<p class="text-gray-500 mt-8">${L}</p>`,M()):(r(`Absensi gagal: ${L}`,"error"),o.textContent=`Gagal Absen: ${L}.`,await y(),u.innerHTML=`<p class="text-red-600 mt-8">Gagal absen: ${L}. Harap coba lagi atau hubungi admin.</p>`)}finally{S=!1}}function F(e){}async function O(){if(f&&k){console.log("Scanner sudah berjalan.");return}try{if(!u){console.error("Elemen 'reader' tidak ditemukan di DOM."),o.textContent="Error: Elemen scanner tidak ditemukan.";return}if(await y(),typeof Html5Qrcode>"u"||!Html5Qrcode.getCameras){o.textContent="Browser tidak mendukung akses kamera atau Html5Qrcode tidak dimuat dengan benar.",u.innerHTML='<p class="text-red-600 mt-8">Browser Anda tidak mendukung akses kamera atau izin ditolak.</p>';return}const e=await Html5Qrcode.getCameras();if(e.length===0){o.textContent="Tidak ada kamera tersedia.",u.innerHTML='<p class="text-red-600 mt-8">Tidak ada kamera yang ditemukan di perangkat Anda.</p>';return}const t=e[0].id;p.innerHTML="",e.forEach(a=>{const n=document.createElement("option");n.value=a.id,n.text=a.label||`Kamera ${a.id}`,p.appendChild(n)}),p.classList.remove("hidden"),p.value=t,p.removeEventListener("change",j),p.addEventListener("change",j),f=new Html5Qrcode("reader"),await f.start({deviceId:{exact:t}},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},z,F),o.textContent="Pindai QR Code untuk Absen...",v=!0,k=!0,console.log("Scanner berhasil dimulai.")}catch(e){console.error("Gagal memulai scanner:",e),o.textContent=`Gagal memulai scanner: ${e.message}`,u.innerHTML=`<p class="text-red-600 mt-8">Gagal memuat scanner: ${e.message}. Pastikan kamera diizinkan.</p>`,p.classList.add("hidden"),v=!1,k=!1}}async function j(e){const t=e.target.value;await oe(t)}async function oe(e){try{await y(),f=new Html5Qrcode("reader"),await f.start({deviceId:{exact:e}},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},z,F),o.textContent="Pindai QR Code untuk Absen...",r("Kamera berhasil diganti.","info"),v=!0,k=!0,console.log("Scanner berhasil di-restart dengan kamera baru.")}catch(t){console.error("Gagal restart scanner:",t),o.textContent=`Gagal mengganti kamera: ${t.message}`,u.innerHTML=`<p class="text-red-600 mt-8">Gagal mengganti kamera: ${t.message}</p>`,v=!1,k=!1}}async function M(){const e=m.getCurrentUser();if(!e||!e.id){r("Gagal memuat status absensi: User tidak terautentikasi.","error"),await y();return}try{const t=await Y.getMyHistory(),a=new Date().toISOString().slice(0,10),n=t.find(s=>s.date===a);if(se(n),n&&(n.status==="Hadir"||n.status==="Telat"||n.status==="Sakit"||n.status==="Cuti"||n.status==="Izin")){await y();let s="";n.status==="Hadir"||n.status==="Telat"?s=`Anda sudah absen masuk hari ini (${n.status}).`:s=`Anda memiliki status hari ini: ${n.status}.`,u.innerHTML=`<p class="text-gray-500 mt-8">${s}</p>`,r(s,"info")}else O()}catch(t){console.error("Error loading my today attendance:",t),r(`Gagal memuat status absensi: ${t.message}`,"error"),q.textContent=new Date().toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"}),C.textContent="Gagal memuat",d.textContent="Error",d.classList.add("text-red-600","font-semibold"),O()}}const re=async()=>{try{if(!localStorage.getItem("token"))return r("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>m.logout(),2e3),null;let t;try{if(t=m.getCurrentUser(),!t)throw new Error("Data pengguna tidak ditemukan di sesi.")}catch(n){throw console.error("Error parsing user from localStorage:",n),new Error("Data pengguna di sesi rusak.")}if(t.role!=="karyawan")return r("Akses ditolak. Peran tidak sesuai untuk halaman ini.","error"),setTimeout(()=>m.logout(),2e3),null;const a=await K.getUserByID(t.id);if(a){try{const n=await K.getProfilePhoto(t.id),c=URL.createObjectURL(n);D.src=c,x&&(x.src=c,x.alt=a.name)}catch{const n="https://via.placeholder.com/80/4A5568/E2E8F0?text=ME";D.src=n,x&&(x.src=n,x.alt=a.name)}V.textContent=a.name,W.textContent=a.position||"-",X.textContent=a.department||"-",a.annual_leave_balance!==void 0&&a.annual_leave_balance!==null?U.textContent=`${a.annual_leave_balance} Hari`:U.textContent="N/A"}return a}catch(e){return console.error("Error fetching employee profile data:",e),r(e.message||"Gagal memuat data profil.","error"),(e.status===401||e.message&&(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Peran tidak sesuai")||e.message.includes("Data pengguna di sesi rusak")))&&setTimeout(()=>m.logout(),2e3),null}},ie=()=>{T.reset(),l.classList.add("hidden"),w.classList.add("hidden"),l.textContent="",w.textContent=""};if(R&&R.addEventListener("click",e=>{e.preventDefault(),ie(),h.classList.remove("hidden"),setTimeout(()=>h.classList.add("active"),10),E&&E.classList.remove("active")}),N&&N.addEventListener("click",()=>{h.classList.remove("active"),setTimeout(()=>h.classList.add("hidden"),300)}),Q&&Q.addEventListener("click",()=>{h.classList.remove("active"),setTimeout(()=>h.classList.add("hidden"),300)}),T&&T.addEventListener("submit",async e=>{e.preventDefault(),l.classList.add("hidden"),w.classList.add("hidden"),l.textContent="",w.textContent="";const t=ee.value,a=te.value,n=ae.value;if(a!==n){l.textContent="Password baru dan konfirmasi password tidak cocok.",l.classList.remove("hidden");return}if(a.length<6){l.textContent="Password baru minimal 6 karakter.",l.classList.remove("hidden");return}const c=m.getCurrentUser();if(!c||!c.id||!localStorage.getItem("token")){r("Sesi tidak valid. Harap login kembali.","error"),setTimeout(()=>m.logout(),2e3);return}try{const s=await m.changePassword(t,a);w.textContent=s.message||"Password berhasil diubah!",w.classList.remove("hidden"),r("Password berhasil diubah!","success"),setTimeout(()=>{h.classList.remove("active"),setTimeout(()=>h.classList.add("hidden"),300)},1500)}catch(s){console.error("Error changing password:",s);const i=s.message||"Gagal mengubah password. Silakan coba lagi.";l.textContent=i,l.classList.remove("hidden"),r(i,"error")}}),B&&(B.addEventListener("click",()=>{E.classList.toggle("active")}),document.addEventListener("click",e=>{B.contains(e.target)||E.classList.remove("active")})),Z.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),de()})}),$&&b&&I&&G){const e=()=>{b.classList.remove("hidden"),setTimeout(()=>{b.classList.add("opacity-100"),I.classList.remove("-translate-x-full")},10)},t=()=>{b.classList.remove("opacity-100"),I.classList.add("-translate-x-full"),setTimeout(()=>b.classList.add("hidden"),300)};$.addEventListener("click",e),G.addEventListener("click",t),b.addEventListener("click",a=>{a.target===b&&t()})}const de=()=>{const e=document.createElement("div");e.className="flex flex-col items-center p-2",e.innerHTML=`
            <p class="font-semibold text-white text-base mb-4">Anda yakin ingin keluar?</p>
            <div class="flex space-x-3">
                <button id="confirmLogoutBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Ya, Keluar</button>
                <button id="cancelLogoutBtn" class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600">Batal</button>
            </div>
        `;const t=J({node:e,duration:-1,gravity:"top",position:"center",close:!0,style:{background:"linear-gradient(to right, #4f46e5, #7c3aed)",borderRadius:"12px",padding:"1rem"}}).showToast();e.querySelector("#confirmLogoutBtn").addEventListener("click",()=>{m.logout(),t.hideToast()}),e.querySelector("#cancelLogoutBtn").addEventListener("click",()=>{t.hideToast()})};await re()&&M()});
