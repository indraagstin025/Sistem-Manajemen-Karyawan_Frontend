import"./input-2b7f90d6.js";import{u as p}from"./UserServices-9109671c.js";import{d as R}from"./DepartemenServices-5d2df75f.js";import{a as g}from"./AuthServices-0f733033.js";import{i as O}from"./sidebarHandler-d6522c99.js";import{i as q}from"./logoutHandler-0fd76589.js";import{S as w}from"./sweetalert2.esm.all-9d2ad45a.js";document.addEventListener("DOMContentLoaded",async()=>{O(),q();const y=document.getElementById("employeeTableBody"),v=document.getElementById("loadingMessage"),o=document.getElementById("employeeListError"),r=document.getElementById("employeeListSuccess"),I=document.getElementById("paginationInfo"),h=document.getElementById("prevPageBtn"),f=document.getElementById("nextPageBtn"),B=document.getElementById("searchInput"),c=document.getElementById("editEmployeeModal"),T=document.getElementById("closeEditEmployeeModalBtn"),M=document.getElementById("cancelEditEmployeeBtn"),E=document.getElementById("editEmployeeForm"),d=document.getElementById("editErrorMessage"),m=document.getElementById("editSuccessMessage"),S=document.getElementById("editEmployeeId"),D=document.getElementById("editName"),A=document.getElementById("editEmail"),P=document.getElementById("editPosition"),x=document.getElementById("editDepartment"),G=document.getElementById("editBaseSalary"),U=document.getElementById("editAddress");let u=1;const _=10;let C="",H="",k=[];const b=(t,e="success")=>{r.classList.add("hidden"),o.classList.add("hidden"),r.textContent="",o.textContent="",e==="success"?(r.textContent=t,r.classList.remove("hidden"),r.classList.remove("text-red-600"),r.classList.add("text-green-600")):(o.textContent=t,o.classList.remove("hidden"),o.classList.remove("text-green-600"),o.classList.add("text-red-600")),setTimeout(()=>{r.classList.add("hidden"),o.classList.add("hidden")},3e3)};if(!localStorage.getItem("token")){b("Anda tidak terautentikasi. Silakan login ulang.","error"),setTimeout(()=>window.location.href="/src/pages/login.html",2e3);return}const j=async()=>{try{k=await R.getAllDepartments(),x.innerHTML='<option value="">Pilih Departemen</option>',Array.isArray(k)&&k.forEach(e=>{const s=document.createElement("option");s.value=e.name,s.textContent=e.name,x.appendChild(s)})}catch(t){console.error("Gagal memuat daftar departemen untuk modal edit:",t),d.textContent="Gagal memuat daftar departemen. Silakan coba lagi.",d.classList.remove("hidden"),(t.status===401||t.message&&t.message.includes("token autentikasi"))&&g.logout()}},l=async()=>{y.innerHTML="",v.classList.remove("hidden");try{const t=await p.getAllUsers(u,_,C,H);v.classList.add("hidden"),t.data&&t.data.length>0?(F(t.data),z(t.total,t.page,t.limit)):(y.innerHTML='<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada data karyawan.</td></tr>',I.textContent="Menampilkan 0 dari 0 karyawan",h.disabled=!0,f.disabled=!0)}catch(t){console.error("Gagal memuat data karyawan:",t),v.classList.add("hidden");let e="Gagal memuat data karyawan. Silakan coba lagi.";t.status===401||t.status===403?(e="Sesi Anda telah berakhir atau Anda tidak memiliki izin. Silakan login kembali.",setTimeout(()=>g.logout(),2e3)):t.message&&(e=t.message),b(e,"error")}},F=async t=>{y.innerHTML="";for(const e of t){const s=document.createElement("tr");s.className="border-b border-gray-100";let n=`https://placehold.co/48x48/E2E8F0/4A5568?text=${e.name?e.name.charAt(0).toUpperCase():"?"}`;try{const i=await p.getProfilePhoto(e.id);i&&i instanceof Blob&&i.size>0&&(n=URL.createObjectURL(i))}catch{console.warn(`Gagal memuat foto untuk user ${e.name}, menggunakan placeholder.`)}s.innerHTML=`
                <td class="px-4 py-3">
                    <img src="${n}" alt="${e.name}" class="h-12 w-12 rounded-full object-cover">
                </td>
                <td class="px-4 py-3">${e.name}</td>
                <td class="px-4 py-3">${e.email}</td>
                <td class="px-4 py-3 capitalize">${e.role}</td>
                <td class="px-4 py-3">${e.position||"-"}</td>
                <td class="px-4 py-3">${e.department||"-"}</td>
                <td class="px-4 py-3">Rp ${e.base_salary?e.base_salary.toLocaleString("id-ID"):"0"}</td>
                <td class="px-4 py-3">
                    <button class="edit-btn text-blue-600 hover:text-blue-800 mr-2" title="Edit" data-id="${e.id}">
                        <i data-feather="edit" class="w-5 h-5"></i>
                    </button>
                    <button class="delete-btn text-red-600 hover:text-red-800" title="Hapus" data-id="${e.id}" data-name="${e.name}">
                        <i data-feather="trash-2" class="w-5 h-5"></i>
                    </button>
                </td>
            `,y.appendChild(s)}feather.replace(),document.querySelectorAll(".edit-btn").forEach(e=>{e.addEventListener("click",s=>K(s.currentTarget.dataset.id))}),document.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",s=>N(s.currentTarget.dataset.id,s.currentTarget.dataset.name))})},z=(t,e,s)=>{const a=(e-1)*s+1,n=Math.min(e*s,t);I.textContent=`Menampilkan ${a}-${n} dari ${t} karyawan`,h.disabled=e===1,f.disabled=n>=t},K=async t=>{d.classList.add("hidden"),m.classList.add("hidden"),d.textContent="",m.textContent="",k.length===0&&await j();try{const e=await p.getUserByID(t);e?(S.value=e.id,D.value=e.name,A.value=e.email,P.value=e.position||"",x.value=e.department||"",G.value=e.base_salary||0,U.value=e.address||"",c.classList.remove("hidden")):b("Data karyawan tidak ditemukan.","error")}catch(e){console.error("Gagal mengambil data karyawan untuk edit:",e),b(`Gagal memuat data edit: ${e.message||"Terjadi kesalahan"}`,"error"),(e.status===401||e.status===403)&&setTimeout(()=>g.logout(),2e3)}},L=()=>{c.classList.add("hidden"),E.reset()};T&&T.addEventListener("click",L),M&&M.addEventListener("click",L),c&&c.addEventListener("click",t=>{t.target===c&&L()}),E&&E.addEventListener("submit",async t=>{t.preventDefault(),d.classList.add("hidden"),m.classList.add("hidden");const e=S.value,s=new FormData(E),a={};for(const[n,i]of s.entries())a[n]=i;if(delete a.id,delete a.password,delete a.role,delete a.photo_file,a.base_salary=parseFloat(a.base_salary),isNaN(a.base_salary)){d.textContent="Gaji pokok harus berupa angka yang valid.",d.classList.remove("hidden");return}try{const n={name:a.name,email:a.email,position:a.position,department:a.department,base_salary:a.base_salary,address:a.address},i=await p.updateUser(e,n);console.log("Karyawan berhasil diupdate:",i),m.textContent="Karyawan berhasil diupdate!",m.classList.remove("hidden"),setTimeout(()=>{L(),l()},1500)}catch(n){console.error("Gagal mengupdate karyawan:",n);let i="Terjadi kesalahan saat mengupdate karyawan. Silakan coba lagi.";n.details?Array.isArray(n.details)?i=n.details.map($=>`${$.Field||"Error"}: ${$.Msg}`).join("<br>"):typeof n.details=="string"&&(i=n.details):n.message&&(i=n.message),d.innerHTML=i,d.classList.remove("hidden"),(n.status===401||n.status===403)&&setTimeout(()=>g.logout(),2e3)}});const N=async(t,e)=>{w.fire({title:`Hapus ${e}?`,text:"Tindakan ini tidak dapat dibatalkan!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal"}).then(async s=>{if(s.isConfirmed)try{const a=await p.deleteUser(t);console.log("Karyawan berhasil dihapus:",a),w.fire({title:"Terhapus!",text:`Karyawan "${e}" berhasil dihapus.`,icon:"success",timer:2e3,showConfirmButton:!1}),l()}catch(a){console.error("Gagal menghapus karyawan:",a);let n="Terjadi kesalahan saat menghapus karyawan. Silakan coba lagi.";a.status===401||a.status===403?(n="Anda tidak memiliki izin untuk menghapus karyawan ini.",setTimeout(()=>g.logout(),2e3)):a.message&&(n=a.message),w.fire({title:"Gagal",text:n,icon:"error",confirmButtonText:"OK"})}})};if(h&&h.addEventListener("click",()=>{u>1&&(u--,l())}),f&&f.addEventListener("click",()=>{u++,l()}),B){let t;B.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{C=B.value,u=1,l()},500)})}l()});
