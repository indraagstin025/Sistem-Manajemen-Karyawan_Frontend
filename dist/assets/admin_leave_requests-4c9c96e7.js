import"./input-69042067.js";import{L as z}from"./LeaveRequestsServices-ddeca199.js";import{a as C}from"./AuthServices-f47c4eb9.js";import{i as X}from"./sidebarHandler-d6522c99.js";import{i as Z,S as O}from"./logoutHandler-87b1a96c.js";import{Q as E}from"./qrCodeHandler-01879f51.js";import{g as F}from"./photoUtils-240b8068.js";import{T as q}from"./toastify-3acd0462.js";/* empty css                 */import"./AttendanceServices-f61bdc29.js";const tt="https://sistem-manajemen-karyawanbackend-production.up.railway.app",et=l=>l?l.startsWith("http://")||l.startsWith("https://")?l:`${tt}${l}`:null,u=(l,b="success")=>{let w;b==="success"?w="linear-gradient(to right, #22c55e, #16a34a)":b==="error"?w="linear-gradient(to right, #ef4444, #dc2626)":w="linear-gradient(to right, #3b82f6, #2563eb)",q({text:l,duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:w,borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",padding:"12px 20px"}}).showToast()},at=()=>{O.fire({title:"Anda yakin ingin keluar?",text:"Anda akan diarahkan ke halaman login.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, Keluar",cancelButtonText:"Batal"}).then(l=>{l.isConfirmed&&C.logout()})};document.addEventListener("DOMContentLoaded",async()=>{feather.replace(),X(),E.initialize({toastCallback:u}),Z({preLogoutCallback:()=>{typeof E<"u"&&E.close&&E.close()}});const l=document.getElementById("leaveRequestsTableBody"),b=document.getElementById("leaveRequestsMessage"),w=document.getElementById("userAvatar"),U=document.getElementById("userNameNav"),v=document.getElementById("dropdownMenu"),V=document.querySelectorAll("#logoutButton, #dropdownLogoutButton, #mobileLogoutButton"),j=document.getElementById("paginationControls"),$=document.getElementById("prevPageBtn"),M=document.getElementById("nextPageBtn"),J=document.getElementById("currentPageInfo"),m=document.getElementById("attachmentViewerModal"),P=document.getElementById("closeAttachmentViewerModalBtn"),T=document.getElementById("attachmentContent"),h=document.getElementById("attachmentErrorMessage"),B=document.getElementById("attachmentModalTitle");let x=1;const k=10;let L=[];const W=async()=>{try{if(!localStorage.getItem("token"))return;let a=C.getCurrentUser();if(!a||a.role!=="admin")return;const r=await F(a.id,a.name,40);w&&(w.src=r,w.alt=a.name||"Admin"),U&&(U.textContent=a.name||"Admin")}catch(e){console.error("Error fetching admin profile data for header:",e)}},_=async()=>{l.innerHTML=`
            <tr>
                <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Memuat pengajuan...</td>
            </tr>
            `,b.classList.add("hidden"),j.classList.add("hidden");try{if(!localStorage.getItem("token")){u("Sesi tidak valid. Mengarahkan ke halaman login...","error"),setTimeout(()=>C.logout(),2e3);return}const a=C.getCurrentUser();if(!a||a.role!=="admin"){u("Akses ditolak. Anda tidak memiliki izin untuk melihat halaman ini.","error"),setTimeout(()=>C.logout(),2e3);return}const r=await z.getAllLeaveRequests();console.log("Data mentah dari API:",r),L=r||[],L.sort((s,o)=>s.status==="pending"&&o.status!=="pending"?-1:s.status!=="pending"&&o.status==="pending"?1:new Date(o.createdAt)-new Date(s.createdAt)),L.length===0?(l.innerHTML=`
                                <tr>
                                    <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Tidak ada pengajuan cuti/izin yang ditemukan.</td>
                                </tr>
                            `,b.textContent="Tidak ada pengajuan cuti atau izin yang perlu ditinjau.",b.classList.remove("hidden")):(A(L,x,k),I(L.length,x,k))}catch(e){console.error("Error loading leave requests:",e),l.innerHTML=`
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-center text-red-500">Gagal memuat pengajuan: ${e.message}</td>
                        </tr>
                    `,u(e.message||"Gagal memuat pengajuan cuti/izin.","error"),(e.message.includes("token")||e.message.includes("sesi")||e.message.includes("Akses ditolak"))&&setTimeout(()=>C.logout(),2e3)}},K=async e=>{const a=e.target.closest(".view-attachment-btn");if(!a)return;const r=a.dataset.url;if(T.innerHTML="",h.classList.add("hidden"),B.textContent="Lihat Lampiran: Memuat...",m.classList.remove("hidden"),setTimeout(()=>m.classList.add("active"),10),!r){B.textContent="Lihat Lampiran: Gagal",h.textContent="URL lampiran tidak ditemukan.",h.classList.remove("hidden"),u("URL lampiran tidak ditemukan.","error");return}const s=localStorage.getItem("token");if(!s){B.textContent="Lihat Lampiran: Gagal",h.textContent="Sesi tidak valid. Harap login ulang.",h.classList.remove("hidden"),u("Sesi tidak valid. Harap login ulang.","error");return}try{const o=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(!o.ok){const n=await o.text();let i=`Gagal memuat lampiran: ${o.status}`;try{i=JSON.parse(n).message||i}catch{i=`${i} - ${n.substring(0,100)}...`}throw new Error(i)}let p="File Lampiran";const t=o.headers.get("Content-Disposition");if(t&&t.includes("filename=")){const n=t.match(/filename="?(.+)"?/);n&&n[1]&&(p=n[1].replace(/['"]/g,""))}B.textContent=`Lihat Lampiran: ${p}`;const g=await o.blob(),c=URL.createObjectURL(g),f=o.headers.get("Content-Type")||g.type;if(f.startsWith("image/")){const n=document.createElement("img");n.src=c,n.alt=p,n.className="max-w-full max-h-full object-contain",T.appendChild(n)}else if(f==="application/pdf"){const n=document.createElement("iframe");n.src=c,n.style.width="100%",n.style.height="100%",n.style.border="none",n.setAttribute("allowfullscreen",""),T.appendChild(n)}else{h.textContent=`Tipe file '${f||"tidak diketahui"}' tidak didukung untuk tampilan langsung. Silakan unduh.`,h.classList.remove("hidden");const n=document.createElement("button");n.textContent="Unduh File",n.className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",n.addEventListener("click",()=>G({target:{dataset:{url:r,filename:p}}})),T.appendChild(n)}m.addEventListener("transitionend",function n(){m.classList.contains("hidden")&&(URL.revokeObjectURL(c),m.removeEventListener("transitionend",n))},{once:!0})}catch(o){B.textContent="Lihat Lampiran: Gagal",console.error("Gagal memuat lampiran untuk tampilan:",o),h.textContent=o.message||"Terjadi kesalahan saat memuat lampiran.",h.classList.remove("hidden"),u(o.message||"Gagal memuat lampiran.","error"),m.classList.remove("active"),setTimeout(()=>m.classList.add("hidden"),300)}},G=async e=>{const a=e.target,r=a.dataset.url,s=a.dataset.filename;if(!r){u("URL lampiran tidak ditemukan.","error");return}const o=localStorage.getItem("token");if(!o){u("Sesi tidak valid. Silakan login ulang.","error");return}const p=a.textContent;a.disabled=!0,a.textContent="Mengunduh...";try{const t=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${o}`}});if(!t.ok){const d=await t.text();let y=`Gagal mengunduh file: ${t.status}`;try{y=JSON.parse(d).message||y}catch{y=`${y} - ${d.substring(0,100)}...`}throw new Error(y)}const g=t.headers.get("Content-Disposition");let c="file";if(g&&g.includes("filename=")){const d=g.match(/filename="?(.+)"?/);d&&d[1]&&(c=d[1].replace(/['"]/g,""))}else if(s)c=s;else{const d=r.split("/");c=d[d.length-1].split("?")[0]}const f=await t.blob(),n=URL.createObjectURL(f),i=document.createElement("a");i.href=n,i.download=c,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(n),u("File berhasil diunduh!","success")}catch(t){console.error("Gagal mengunduh file:",t),u(t.message||"Terjadi kesalahan saat mengunduh file.","error")}finally{a.disabled=!1,a.textContent=p}},A=(e,a,r)=>{const s=document.getElementById("leaveRequestsTableBody");if(!s)return;s.innerHTML="";const o=(a-1)*r,p=e.slice(o,o+r);if(p.length===0){s.innerHTML='<tr><td colspan="9" class="text-center py-10 text-gray-500">Tidak ada data pengajuan.</td></tr>';return}p.forEach(t=>{console.log("Merender request:",t.id,"dengan attachment_url:",t.attachment_url);const g=s.insertRow(),c=new Date(t.start_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),f=new Date(t.end_date+"T00:00:00").toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});let n="pending",i="Menunggu";t.status==="approved"?(n="approved",i="Disetujui"):t.status==="rejected"?(n="rejected",i="Ditolak"):t.status==="completed"&&(n="completed",i="Selesai");const d=et(t.attachment_url),y=t.attachment_url?t.attachment_url.split("/").pop().split("?")[0]:"",D=d?`<div class="flex items-center space-x-2">
                            <button class="view-attachment-btn text-teal-600 hover:underline focus:outline-none" data-url="${d}" data-filename="${y}">Lihat</button>
                            <button class="download-btn text-gray-500 hover:text-gray-700" data-url="${d}" data-filename="${y}" title="Unduh Lampiran">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                        </div>`:"-",R=t.user_name||t.user_email||"Pengguna Tidak Dikenal",H=`photo-${t.id}`;g.innerHTML=`
                <td>
                    <div class="employee-info flex items-center space-x-3 px-6 py-4 whitespace-nowrap">
                        <img id="${H}" class="h-9 w-9 rounded-full object-cover" src="https://placehold.co/36x36/E2E8F0/4A5568?text=ME" alt="${R}">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${R}</div>
                            <div class="text-sm text-gray-500">${t.user_email||"-"}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.request_type||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${f}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis" title="${t.reason||""}">${t.reason||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${D}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                    <span class="status-badge ${n}">${i}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis" title="${t.note||""}">${t.note||"-"}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    ${t.status==="pending"?`
                            <div class="action-buttons flex space-x-2 justify-end">
                                <button data-id="${t.id}" data-action="approve" class="action-btn px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md transition-colors duration-200">Setujui</button>
                                <button data-id="${t.id}" data-action="reject" class="action-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition-colors duration-200">Tolak</button>
                            </div>
                            `:'<span class="text-gray-500 text-xs">Selesai</span>'}
                </td>
            `,F(t.user_id,R,36).then(Y=>{const N=document.getElementById(H);N&&(N.src=Y)})})},I=(e,a,r)=>{const s=Math.ceil(e/r);J.textContent=`Halaman ${a} dari ${s}`,$.disabled=a===1;const o=e===0||a===s;M.disabled=o,e>r?j.classList.remove("hidden"):j.classList.add("hidden")},Q=async e=>{const a=e.target,r=a.dataset.id,s=a.dataset.action;let o="",p="",t="",g="",c="",f="question";if(s==="approve")o="approved",p="Setujui Pengajuan Ini?",t="Anda akan menyetujui pengajuan cuti/izin ini.",g="Catatan persetujuan (wajib)",c="Catatan Persetujuan:",f="success";else if(s==="reject")o="rejected",p="Tolak Pengajuan Ini?",t="Anda akan menolak pengajuan cuti/izin ini.",g="Catatan penolakan (wajib)",c="Catatan Penolakan:",f="error";else return;const{value:n}=await O.fire({title:p,text:t,icon:f,input:"textarea",inputLabel:c,inputPlaceholder:g,inputValidator:i=>{if(!i||i.trim()==="")return"Catatan wajib diisi!"},showCancelButton:!0,confirmButtonText:"Ya, Proses",cancelButtonText:"Batal",confirmButtonColor:s==="approve"?"#10b981":"#dc2626",cancelButtonColor:"#6b7280",reverseButtons:!0});if(n==null||n.trim()===""){u("Proses dibatalkan: Catatan tidak diisi.","info");return}try{a.disabled=!0,a.textContent="Memproses...",await z.updateLeaveRequestStatus(r,o,n),u(`Pengajuan berhasil ${s==="approve"?"disetujui":"ditolak"}.`,"success"),_()}catch(i){console.error("Error updating leave request status:",i),u(i.message||"Gagal memperbarui status pengajuan.","error"),a.disabled=!1,a.textContent=s==="approve"?"Setujui":"Tolak"}};$&&$.addEventListener("click",()=>{x>1&&(x--,A(L,x,k),I(L.length,x,k))}),M&&M.addEventListener("click",()=>{const e=Math.ceil(L.length/k);x<e&&(x++,A(L,x,k),I(L.length,x,k))}),l&&l.addEventListener("click",e=>{const a=e.target;a.classList.contains("action-btn")?Q(e):a.classList.contains("view-attachment-btn")?K(e):a.classList.contains("download-btn")&&G(e)});const S=document.getElementById("userDropdown");S&&v&&(S.addEventListener("click",e=>{!v.contains(e.target)&&e.target.closest("#userAvatar")&&(v.classList.toggle("hidden"),v.classList.toggle("active"))}),document.addEventListener("click",e=>{v&&!S.contains(e.target)&&!v.contains(e.target)&&(v.classList.remove("active"),setTimeout(()=>{v.classList.add("hidden")},200))},!0)),V.forEach(e=>{e.addEventListener("click",a=>{a.preventDefault(),at()})}),P&&(P.addEventListener("click",()=>{m.classList.remove("active"),setTimeout(()=>{m.classList.add("hidden"),T.innerHTML="",h.classList.add("hidden")},300)}),m.addEventListener("click",e=>{e.target===m&&(m.classList.remove("active"),setTimeout(()=>{m.classList.add("hidden"),T.innerHTML="",h.classList.add("hidden")},300))})),W(),_()});
